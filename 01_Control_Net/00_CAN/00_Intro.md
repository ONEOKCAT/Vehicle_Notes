## 1 &#8194; CAN 时代背景 & 推动因素

&#8194;&#8195;汽车近年来的发展呈现出以电子化为主的特点，一方面是由于用户对汽车需求的不断增长，以及日益严格的汽车排放法规；另一个因素是全球化加剧了汽车生产的竞争和成本压力，直接导致创新压力不断增加。  

&#8194;&#8195;在此背景下，汽车电控单元数量呈指数级增长，其导致电控单元间交互数据量递增，并要求电控单元的交互方式与时俱进。

## 2 &#8194;Conversational Networking

&#8194;&#8195;车辆复杂功能的实现需要ECU彼此协调工作。  

&#8194;&#8195;最初，ECU 之间数据交换是以传统方式（即点对点）实现的，即为每一个传输信号分配一个物理通信通道（硬线连接，专线专用）。  

&#8194;&#8195;但随着 ECU 数量的增长，线束数量也随之增加，导致的直接影响就是：  

&#8194;&#8194;&#8195;- 线束成本增加，汽车作为大规模量产化产品，对于成本是及其敏感的；  

&#8194;&#8194;&#8195;- 线束重量增加；  

&#8194;&#8194;&#8195;- 整车布线的复杂程度提升；  

&#8194;&#8195;此外，基于点对点的拓扑，也不便于进行网络扩展。

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Bus_Networking.png)

## 3 &#8194;Bus Networking

&#8194;&#8195;采用总线式网络能够很好解决上述问题（通过单个通信通道（总线）进行串行位数据交换）。所谓总线式结构，即节点间数据传输共享同一介质/总线，需要参与数据交互的节点，将会以支线的方式挂载在总线上。  

&#8194;&#8195;其优点除了减少线束数量以降低成本及重量外，扩展性也得以提升，新节点的加入无需对原有网络的软硬件进行过多的修改。  

&#8194;&#8195;此外，通信故障会更容易被诊断，例如，想要监测总线上的信号问题，直接将诊断仪作为节点接入到总线中即可。  

&#8194;&#8195;总线拓扑主要的缺陷在于，因为所有数据传输共享同一总结，总线带宽就成为了传输速率的瓶颈。

## 4 &#8194;CAN-Bus 优势一览

&#8194;&#8195;直至今日，CAN 总线仍然在汽车动力系统、底盘和舒适系统等网络中发挥着重要作用；最重要的是，CAN 具有数据传输非常可靠的特点，可以满足应用领域的实时要求：  

&#8194;&#8194;&#8195;- **高可靠性**：CAN 总线采用无主的网络架构，网络传输不依赖于主机的可靠性，任何节点失效都不会影响其他节点和网络；  

&#8194;&#8194;&#8195;- **低成本**：CAN 总线采用无主的网络架构，网络传输不依赖于主机的可靠性。CAN 总线采用消息ID和消息体的传输机制(无网络节点ID)，每个节点可发送或接收多个 ID 的消息，任何节点失效都不会影响其他节点和网络；  

&#8194;&#8194;&#8195;- **高传输效率**：CAN 总线使用面向位流编码的短数据帧，每个位都采用不归零编码，数据域最大长度位8字节。传输短数据帧时占用的网络周期短，受干扰或导致错误数据位的概率低，而且重传的时间也短；  

&#8194;&#8194;&#8195;- **易组网**：CAN 总线采用消息ID(11位或29位两种长度的消息ID)的二进制‘0’位的多少分配消息传输优先级，允许多个节点自动竞争和仲裁获取总线的占用权，甚至支持即插即用的节点；  

&#8194;&#8194;&#8195;- **开放协议和生态系统**：CAN 总线得到广泛应用的关键应归功于 Bosch 最初采用的开放版权策略，以及由半导体制造商(协议栈的硬件化)、汽车零部件开发商、软件开发商和行业协会等共同参与而打造的 CAN 总线生态；

## 5 &#8194;CAN-Bus 结构概述

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Bus_CAN%20Structure.png)

&#8194;&#8195;- **Microcontroller**: 主导与其他节点的通信，即应用层的交互；  

&#8194;&#8195;- **CAN 接口**: ECU 需要 CAN 接口才能参与 CAN 通信；CAN 接口由 CAN 控制器和 CAN 收发器组成；CAN 控制器执行 CAN 协议规定的通信功能 （ISO-11898 中也称其为 CAN-Protocol-Controller），从而大大减轻了 Microcontroller 的负担；  

&#8194;&#8195;- **发送过程**: Mircocontroller 将应用数据传递给 CAN-Controller；CAN-Controller 会完成报文的封装，接着将数据以二进制码流的方式发送给 CAN-Transceiver；CAN-Transceiver 负责二进制信息流与物理电平信号间的转换，根据 CAN 标准定义的物理层协议，将 CAN_H （CAN 高信号线） 和 CAN_L （CAN 低信号线） 两根线的电平拉到相应阈值；   

&#8194;&#8195;- **接收过程**: CAN-Transceiver 检测到总线数据时，会将 CAN_H / CAN_L 上的差分电平解析成适用于数据链路层传输的所谓 “0101...” 的比特流，将其传递给 CAN-Controller；CAN-Controller 对数据进行解封装后，打包传递给 Mircocontroller 进行处理；  

&#8194;&#8195;此外，使用终端电阻连接通信通道的两末端（模拟传输介质的电特性）可防止在高速 CAN 网络中发生反射；  

&#8194;&#8195;典型状态下：  

&#8194;&#8195;CAN总线为“隐性”（逻辑 1）时，CAN_H 和 CAN_L 的电平为 2.5V（电位差 Vdiff 为 0 V）；  

&#8194;&#8195;CAN总线为“显性”（逻辑 0）时，CAN_H 和 CAN_L 的电平分别是 3.5V 和 1.5V（电位差 Vdiff 为 2.0 V），且显性位会覆盖隐形位。


## 6 &#8194;CAN-Bus 发展及协议概述

&#8194;&#8195;1983 年，Bosch 开发了一种新的串行通信系统，即 CAN。  

&#8194;&#8195;1986 年，Bosch 公司在 SAE（美国汽车工程师协会）大会上正式公布了 CAN 协议。

&#8194;&#8195;1989 年，Bosch 发布 CAN 1.1 标准；1990年，Bosch 发布 CAN 2.0 标准：CAN 2.0 A 和 CAN 2.0 B 分别描述了传统 CAN 的标准帧和扩展帧格式。

&#8194;&#8195;1993 年 11 月，ISO 颁布了第一版 CAN 国际标准（ISO 11898: 1993），以及随后的 ISO 11519: 1994： 

&#8194;&#8194;&#8195;- 其中，ISO 11898 是通信速度为 125 kbit/s - 1 Mbit/s 的高速 CAN 通信标准，规范中同时定义了数据链路层和高速物理层；(500 kbit/s 和 <250kbit/s - J1939> 是最为常用的传输速率。)

&#8194;&#8194;&#8195;- ISO 11519 是通信速度为 125 kbit/s 以下的低速 CAN 通信标准，即容错 CAN（LSFT-CAN），其允许在 CAN 总线连线失败时总线通信得以继续进行。  

&#8194;&#8195;2003 年，ISO 将原先的 ISO 11898 协议拆分为 ISO 11898-1 和 ISO 11898-2 两部分；后续又发布了其他几个部分：  

&#8194;&#8194;&#8195;- ~~ISO 11898-1: 2003~~ & ~~ISO 11898-1: 2015~~ & ***ISO 11898-1: 2024 - PART 1: Data link layer and physical signalling;***   （包含 CAN FD 和 CAN XL 标准）

&#8194;&#8194;&#8195;- ~~ISO 11898-2: 2003~~ & ~~ISO 11898-2: 2016~~ & ***ISO 11898-2: 2024 - PART 2: High-speed medium access unit;***  

&#8194;&#8194;&#8195;- ***ISO 11898-3: 2006 - PART 3: Low-speed, fault-tolerant, medium-dependent interface;***  

&#8194;&#8194;&#8195;- ***ISO 11898-4: 2004 - PART 4: Time-triggered communication;***  

&#8194;&#8194;&#8195;- ~~ISO 11898-5: 2007~~ - PART 5: High-speed medium access unit with low-power mode;  

&#8194;&#8194;&#8195;- ~~ISO 11898-6: 2013~~ - PART 6: High-speed medium access unit with selective wake-up functionality;  

* ISO-11519-2: 1994 <Low-speed controller area network (CAN)> 被 ISO 11898-3: 2006 替代；

* ISO 11898-1: 2003 & ISO 11898-5: 2007 & ISO 11898-6: 2013 合并为 ISO 11898-2: 2016；

&#8194;&#8195;CAN-Bus 本质是一种异步串行通讯低层网络。对照 OSI 模型，其规范标准仅包含物理层和数据链路层部分。但构建在 CAN 之上的应用层协议有多种， 譬如针对汽车控制领域和工业控制领域的 CANopen 协议、针对工业控制领域的 DeviceNet 协议、针对公交车和卡车控制领域的 SAE J1939 协议、针对轻型电动汽车领域的 EnergyBus 协议等。

## 7 &#8194;CAN-Bus 框架概述

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Bus_the_relationship_between_the_OSI_layers_and_the_CAN_sub-layers.png)

>* ISO 11898-1 对应 CAN-Bus 结构中 CAN (Protocol) Controller 部分;
>
>* ISO 11898-2 对应 CAN-Bus 结构中 CAN Transceiver 部分;

>&#8194;&#8195;基本释义：
>
>&#8194;&#8194;&#8195;- ***LLC***: Logic Link Control 
>
>&#8194;&#8194;&#8195;- ***MAC***: Medium Access Control   
>
>&#8194;&#8194;&#8195;- ***PCS***: Physical Coding Sub-layer   
>
>&#8194;&#8194;&#8195;- ***PWM***: Physical medium attachment  
>
>&#8194;&#8194;&#8195;- ***AUI***: Attachment unit interface  
>
>&#8194;&#8194;&#8195;- ***PMA***: Physical medium attachment  
>
>&#8194;&#8194;&#8195;- ***MDI***: physical medium dependent  
>
>&#8194;&#8194;&#8195;- ***PMD***: Pulse-width Modulation

&#8194;&#8195;ISO 11898-2 与 ISO 11898-3 规定的标准范围是相同的（如上图所示），前者针对的是高速 CAN 而后者描述的是低速 CAN。

# 8 &#8194;CAN FD 推动因素与概述

&#8194;&#8195;**起源**：2012 年，开始开发第二代 CAN 通信技术，即众所周知的 CAN FD (CAN with Flexible Data rate)，并在两年后的法国巴黎第 14 届 iCC（international CAN Conference）上正式推出。

&#8194;&#8195;**信号数量大量增加**：引入CAN总线的数十年中，汽车嵌入式系统的结构发生了深远的变化，最明显的变化是数量：如果在引入CAN时只需传输数百个信号，那么今天这个数字已达到五位数。

&#8194;&#8195;**新要求 & 新总线系统**：数据流量的增加导致 CAN 总线上的总线负载率越来越高。除了对带宽的需求在不断增加，对确定性系统行为的需求也在不断增长，这刺激了新总线系统的开发。因此，出于信息娱乐目的，开发了带宽高达 150 Mbit/s 的 MOST 总线（2001 年首次推出）。确定性 FlexRay 总线（2008 年全面推出）可提供 10 Mbit/s 的带宽，用于驾驶员辅助功能。在带宽范围的低端，引入了 LIN 作为低成本解决方案，用于完成传感器-执行器-区域中的任务。以及这些新的总线系统覆盖了各个领域，但 CAN 仍然是主流的汽车总线系统。

&#8194;&#8195;**CAN 并未被取代**：实际上，在 CAN FD 被开发之前，只有极少数的 CAN 需要替换为传输速率更快的总线，例如 FlexRay 。但没有替换的主要原因是硬件成本较高以及将系统转化为新技术的开发工作巨大。

&#8194;&#8195;使用更多路 CAN 总线通常可以规避 CAN 带宽不足，但这需要网关在总线之间传输数据。

&#8194;&#8195;**CAN 性能限制**：CAN 带宽的限制因素源于自身的一个核心属性，即在报文传输的特定阶段，多个网络节点可能同时处于传输模式。仲裁阶段传输开始时可能就是这种情况，并且在报文末尾的应答场中也是始终如此。这意味着一个位的传输时间不得短于其电压电平从总线一端的节点传播到另一端的节点再返回所需的时间。例如：在长度为 40 米的 CAN 总线上，若要满足一个位所需的传输时间，最大传输速率应约为 1 Mbit/s。

&#8194;&#8195;**更短的位时间也能满足**：但在 CAN 报文仲裁阶段和应答场之间，仅允许一个发送节点。因此，这一部分对位时间的最小持续时间没有限制。那么在博世的工程师看来，如果在 CAN 报文这一部分提高传输速率会怎样？只需在两个不同的传输速率之间切换，即在 CAN 报文的开头和末尾切换为慢速，在中间切换为快速。这就是 CAN FD 的基本概念。

&#8194;&#8195;**CAN FD 优势一览**：

&#8194;&#8194;&#8195;**- 更多数据，更低总线负载率**：传统 CAN 每帧报文最大只能传输 8 个字节的数据，CAN FD 最大可以一次传输 64 个字节；传统 CAN 最高支持 1 Mb/s 的传输速率，CAN FD 仲裁段支持的最高传输速率与传统 CAN 相同，为 1 Mb/s，数据段最高支持 8 Mb/s的传输速率；

&#8194;&#8195;&#8195;注：CAN FD 最高可达 2 Mbit/s，CAN FD-SIC 最高可达 5-8 Mbit/s；<signal improvement capability：信号改进能力>。

&#8194;&#8194;&#8195;**- 简化开发**：不再需要使用多条 CAN 总线，即使未能消除对网关的需求，也会大大减少；使用更少的帧，获得更理想的有效负载与开销数据比。

&#8194;&#8195;**控制器需求**：为了确保 CAN FD 正常工作，需要新的 CAN FD 控制器。CAN FD 控制器是向下兼容的，并且能够处理 Classical CAN 。CAN 总线上的 ECU 可以逐步替换为支持 CAN FD 的 ECU 。当然，只要有一个具有常规 CAN 控制器的 ECU，就必须使用经典 CAN 。似乎只有总线上的所有 ECU 都升级为 CAN FD 控制器后，才能利用 CAN FD 的优势，这并不绝对，部分 ECU 支持 CAN FD，能够以更高的速度通信，而其他 ECU 进入睡眠状态。

# 9 &#8194;CAN XL 推动因素及概述

&#8194;&#8195;**起源**：2020 年的第 17 届国际 CAN 大会（iCC）上，第三代 CAN 通信技术 CAN XL 启动。

&#8194;&#8195;**推动**：新的应用案例和不断增长的带宽要求使传统的 CAN 和 CAN FD 达到了极限；" Large Bit rate gap between CAN FD and 100BASE-T1 Ethernet. "

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CANXL-Bit_Rate_gap_between_CANXL_and_100BASE-T1_Ethernet.png>

&#8194;&#8195;**CAN XL 优势一览**：

&#8194;&#8194;&#8195;**- 更高的比特率**：支持 10 ~ 20 Mbit/s，具体取决于拓扑结构；（CAN SIC XL Transceiver）

&#8194;&#8194;&#8195;**- 更多的有效载荷**：高达 2048 字节的数据字段，意味着可支持使用更高层的协议嵌入，例如IP（Internet协议），甚至可以传输完整的以太网帧；

&#8194;&#8195;&#8195;CAN XL 帧中提供了一个新字段用于指示有效载荷中的数据类型，即通过该字段可以实现在同一总线上运行多个高层协议；例如，可以同时支持基于服务的以太网通信和基于信号的 CAN 通信。

&#8194;&#8195;&#8195;**更安全**：例如，通过两个 CRC 字段来提升可靠性； 















