# 1 &#8194;Intro

>&#8194;&#8195;ISO 11898-1 定义了 CAN Data Link Layer（**DLL**，分为 LLC 及 MAC 两部分）以及 Physical Coding Sub-layer（PCS，位于 **PL** - Physical Layer）；
>
>&#8194;&#8195;DLL 利用 service data unit (**SDU** 即 **LLC Frame**）以链接 LLC 和 MAC，且 LLC Frame 还具有 service data unit type (**SDT**) and the virtual CAN
channel identifier (**VCID**)，提供了更高层的协议配置和标识信息；  
>
>&#8194;&#8195;ISO 11898-1: 2024 提供了以下五种节点选项：
>
>&#8194;&#8194;&#8195;1. support ofthe CAN classic frame format only,not tolerating the CAN flexible data rate(FD)frame format;
>
>&#8194;&#8194;&#8195;2. support ofthe CAN classic frame format and tolerating the CAN FD frame format;  
>
>&#8194;&#8194;&#8195;3. support ofthe CAN classic frame format and the CAN FD frame format;  
>
>&#8194;&#8194;&#8195;4. support ofthe CAN classic frame format,the CAN FD frame format andthe CAN XL frame format;  
>
>&#8194;&#8194;&#8195;5. support ofthe CAN FD frame format for CAN FD light responders.
>
>* &#8194;选项 1 节点可与选项 3 和 4 节点进行通信，但无法和选项 5 节点通信（任何通信尝试都会产生错误帧）；
>* &#8194;选项 4 节点可与所有类型节点通信。

## 1.1 &#8194;CAN Type

&#8194;&#8195;**CAN**: 又被称为 Classical CAN。  

&#8194;&#8195;**CAN-FD**（Flexible Data-Rate）: 为克服传统 CAN 协议的带宽限制，CAN-FD 允许更高的数据传输速率和更大的数据帧，提供了更灵活的数据传输选项；    

&#8194;&#8195;**CAN-XL**（Extended Length）: 作为 CAN-FD 的进一步扩展，旨在进一步增加数据传输速率和灵活性，支持更大的数据帧和更高的传输速率；  

&#8194;&#8195;ISO-11898-1: 2024 中定义了五种 CAN Type：  

&#8194;&#8194;&#8195;1. **CBFF** : Classical Base Frame Format  

&#8194;&#8194;&#8195;2. **CEFF** : Classical Extended Frame Format  

&#8194;&#8194;&#8195;3. **FBFF** : FD Base Frame Format  

&#8194;&#8194;&#8195;4. **FEFF** : FD Extended Frame Format  

&#8194;&#8194;&#8195;5. **XLFF** : XL Frame Format  

# 2 &#8194;Basic concepts of CAN

## 2.1 &#8194;CAN properties

>&#8194;&#8195;**1. Multi-master priority-based bus access;**
>
>&#8194;&#8195;**2. Non-destructive content-based arbitration;** # [2.2](#22-frame-transmissions)
>
>&#8194;&#8195;**3. All frame transfers are done as broadcast;**
>
>&#8194;&#8195;**4. Multicast frame transfer by acceptance filtering;** # [2.5](#25-information-routing)
>
>&#8194;&#8195;**5. Remote data request;** # [2.6](#26-remote-data-request)
>
>&#8194;&#8195;**6. Configuration flexibility;** # [2.4](#24-network-flexibility)
>
>&#8194;&#8195;**7. Error detection and error signalling;** # [2.7](#27-Error-detection) # [2.8](#28-Error-signalling-and-recovery-time) # [2.9](#29-Fault-confinement) # [2.10](#210-Error-active) # [2.11](#211-Error-passive) # [2.12](#212-Bus-off)
>
>&#8194;&#8195;**8. Retransmission of frames that lose bus arbitration, are not acknowledged, or are invalided by errors;** # [2.14](#214-Repetition-of-transmission)
>
>&#8194;&#8195;**9. Network-wide data consistency.** # [2.15](#215-Network-wide-data-consistency)
>
>* &#8194;The following properties can be omitted by configuration: retransmission, error signalling, network-wide data consistency and remote data request. 

&#8194;&#8195;ISO 11898-1 定义了多主架构，以确保高可用性和事件驱动的数据传输；CAN 网络中的每个节点都有权访问 CAN 总线，无需请求许可，也无需事先与其他 CAN 节点进行协调。虽然基于事件驱动的总线访问对事件的响应非常快，但也存在风险，即多个 CAN 节点可能同时访问 CAN 总线，从而导致 CAN 总线上出现数据重叠。

## 2.2 &#8194;Frame transmissions

>&#8194;&#8195;The DLL sends different frames: data frames (DF), remote frames (RF), error frames (EF) and overload frames (OF).

&#8194;&#8195;CAN-Bus 的空闲状态意味着总线上无任何帧传输，此时 CAN 节点可以开始 DF 或 RF 的传输；当节点检测到错误条件或过载条件时，将会发送 EF 或 OF。

## 2.3 &#8194;Bus access method

&#8194;&#8195;原则上，CAN-Bus 访问采用“先到先得”机制，即先发送的帧具有更高优先级；若多个节点同时传输 DF 或 RF，将通过非破坏性仲裁机制，其本质是使用标识符（CAN-ID 越小，优先级越高）来解决总线访问冲突。

>* &#8194;The mechanism of arbitration ensures that neither information nor time is lost.
>
>* &#8194;A DF with the same ID as an RF wins.

## 2.4 &#8194;Network flexibility

>&#8194;&#8195;Nodes can be added to the network without requiring any change in the software or hardware of any node, if the added node is not the transmitter of any DF and if the added node does not require any additional transmitted data.

## 2.5 &#8194;Information routing

&#8194;&#8195;所谓帧接收过滤，指的是节点有权决定接收数据与否，从而实现仅接收与其相关的信息；此外，接收节点无需知晓数据的发送方，反之亦然。

## 2.6 &#8194;Remote data request

>&#8194;&#8195;By sending an RF, a node requiring data requestsanother node to send the corresponding DF: the RF and the corresponding DF are named by the same identifier and using the same DLC.

&#8194;&#8195;CAN 节点可以使用 RF （不携带数据部分）来请求其他节点响应具有相同 CAN-ID 和 DLC 的 DF；  

&#8194;&#8195;原则上，可以为 CAN 网络中的所有数据帧定义远程帧，仅需确保远程帧的标识符与所关联数据帧的ID匹配，发送节点通过发送数据帧来响应远程帧；  

&#8194;&#8195;但 RF 实际应用较少，基本无。

## 2.7 &#8194;Error detection

>&#8194;&#8195;- Monitoring (transmitters comparethe transmitted bit levels with the bit levels detected on thenetwork);

&#8194;&#8195;&#8195;- 通过 CRC Field 实现；  

&#8194;&#8195;- Fixed bit stuffing with a stuffrate of 5 (used in the FD CRC field);  

&#8194;&#8195;- Fixed bit stuffing with a stuffrate of 11 (used in the XL data phase);  

&#8194;&#8195;- Frame format check;  

&#8194;&#8195;- ACK check.

## 2.8 &#8194;Error signalling and recovery time

>&#8194;&#8195;Corrupted frames are flagged by transmitting nodes and by error-active receiving nodes. Such frames are
aborted and retransmitted according to the implemented recovery procedure.

## 2.9 &#8194;Fault confinement

>&#8194;&#8195;CAN nodes can distinguish short disturbances from permanent failures. Defective transmitting nodes are switched off. Switched off means a node is logically disconnected from the bus, so that it can neither send nor receive frames.

## 2.10 &#8194;Error-active

>&#8194;&#8195;An error-active node takes part in network communication and sends an active error flag when an error is detected. The active error flag consists of six consecutive dominant bits and violates the rule of bit-stuffing and all fixed formats appearing in a DF and RF.

## 2.11 &#8194;Error-passive

>&#8194;&#8195;An error-passive node sends no active error flag. It takes part in network communication, but when an error is detected a passive error flag is sent. The passive error flag consists of six consecutive recessive bits. After transmission,an error-passive node waits additional time before initiating a further transmission.

## 2.12 &#8194;Bus-off

>&#8194;&#8195;A node is in the bus-off state when it is switched off from the bus due to an FCE （Fault confinement Entity） request. In the bus-off state, a node neither sends nor receives frames. In the bus-off state, a node does not send any dominant bits.
>
>&#8194;&#8195;- Nodes with disabled error signalling do not enter bus-off state.  
>
>&#8194;&#8195;- Nodes with disabled error signalling do not enter error-passive state.

## 2.13 &#8194;ACK

>&#8194;&#8195;Receivers check the consistency of the received DFs and RFs, acknowledge a consistent frame and,when error signalling is enabled, flag an inconsistent frame by means of EFs.

## 2.14 &#8194;Repetition of transmission 

>&#8194;&#8195;The number of automatic retransmissions of DFs or RFs that are not transmitted successfully by any reason,except the loss of bus arbitration, can be configurable to a dedicated number. That number can reach from zero tounlimited, while unlimited means that retransmissions are only limited by the error counting mechanisms.

&#8194;&#8195;仲裁失败的 DF 或 RF 将会自动重新参与仲裁。

## 2.15 &#8194;Network-wide data consistency

>&#8194;&#8195;Network configuration decides whether nodessignal the errors detectedin frames. When error signalling is enabled within a network, a frame can be simultaneously accepted as a valid frame either by all nodes or by no node.
>
>&#8194;&#8195;Thus, data consistency is a property of the network achieved by the concepts of the broadcast and by the error handling. When error signalling is disabled within a network, local errors can prevent specific nodes from receiving frames that are received by other nodes.

# 3 &#8194;CAN Data-Link-Layer Specification

## 3.1 &#8194;General

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Layered_architecture.png width="500px">


>&#8194;&#8195;... the LLC sub-layer (responsible for flow control, recovery management and time-stamping) ... 
>
>&#8194;&#8195;The DLL has a cross-layer function interface to the FCE. The MAC sub-layer operations are supervised by the FCE. **Fault confinement is a self-checking mechanism**, that distinguishes short disturbances from permanent failures.

## 3.2 &#8194;Time stamping

>&#8194;&#8195;The DLL may have a cross-layer function interface to a time-base for the time-stamping. When the time-stamping is not supported, time-base and time-stamps shall be treated as constant with the value 0.

&#8194;&#8195;Time stamping 指 CAN 支持时间触发模式，该模式下 CAN 节点内部定时器被激活，且被用于产生（发送和接收数据的）时间戳，存储在 CAN 寄存器内部。

&#8194;&#8195;内部定时器在每个 CAN 的位时间累加，在接收和发送的帧起始位的采样点位置被采样，并生成时间戳。

## 3.3 &#8194;DLL protocol

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Protocol_layer_interactions.png width="540px">

>&#8194;&#8195;**The DLL's SDU is called the LLC frame;** it also interfaces between the LLC sub-layer and the MAC sub-layer.
>
>&#8194;&#8195;**The DLL's PDU is called the MAC frame. This is the bit sequence seen on the CAN bus.** The MAC frame maybe
in CBFF, CEFF, FBFF, FEFF, or XLFF.

## 3.4 &#8194;LLC sub-layer

### 3.4.1 &#8194;Overview

>&#8194;&#8195;The LLC sub-layer shall provide the following functions: flow control, recovery management and time-stamping. # [4.4.6 Function of LLC](#446-functions-of-the-llc-sub-layer)
>
>&#8194;&#8195;The LLC sub-layer shall offer two types of connectionless transmission services to the LLC user.

### 3.4.2 &#8194;Notifications

&#8194;&#8195;The notifications sent between the LLC user and the LLC sub-layer are specified in following:

* &#8194;Notification sent from LLC user to LLC sub-layer
  
| Notification | Description |
| --- | --- |
| Reset_Request | Request to set the node into an initial state |

* &#8194;Notification sent from LLC sub-layer to LLC user
  
| Notification | Description |
| --- | --- |
| Reset_Response | Response to the Reset_Request |
| Node_Status | Indicates the current status of the node, i.e.it signals whether or not the node is in the bus-off state. |

### 3.4.3 &#8194;Structure of LLC frame

| Field | Size | Description |
| ---- | ---- | ---- |
| **ID** | (11+18) bit | Priority identifier:ID (28) to ID (18) are used for all frames with 11 - bit identifier format (CBFF,FBFF,XLFF) while ID (28) to ID (0) are used for all frames with 29 - bit. identifier format (CEFF, FEFF). |
| **Format** | 3 bit | The frame format is coded by the three bits IDE, FDF, and XLF <br /> - if 000, the MAC frame format is CBFF; <br /> - if 100, the MAC frame format is CEFF; <br /> - if 110, the MAC frame format is FEFF;<br /> - if 011, the MAC frame format is XLFF. |
| FTYP | 1 bit | **In CBFF and CEFF, the FTYP bit corresponds to the MAC frame's RTR bit**, this means that FTYP distinguishes between the frame types RF (FTYP = 1p) and DF ( FTYP = 0p); <br /> In FBFF and FEFF, the FTYP bit is ignored for transmission but corresponds to the MAC frame's RRS bit for reception; <br /> In XLFF, the FTYP bit corresponds to the MAC frame's RRS bit. |
| BRS | 1 bit | Bit rate switch: only used in FBFF and FEFF frames. |
| ESI | 1 bit | Error state indicator: only used in FBFF and FEFF frames. |
| SDT | 1 bit | SDU type: describes the structure of the frame's data field content, only used in XLFF frames. |
| SEC | 1 bit | Simple/extended content:flags if the data field contains simple orextended content. This is only used in XLFF frames. |
| **DLC** | (7+4) bit | Data length code: 7 MSB only used in XLFF frames. For XLFF frames the numbers 0 to 2047 code 1 to 2048 data bytes. **For DFs of all other formats the 4 LSB encode the number or data bytes.** |
| VCID | 1 bit | Virtual CAN channel ID: only used in XLFF frames. |
| AF | 4 bit | Acceptance field: only used in XLFF frames. |
| **LLC Data** | 0 to 2048 byte | Payload of the LLC frame. |

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-DLC_Coding.png width="400px">

### 3.4.4 &#8194;Limited LLC frames

>* &#8194;A subset of the complete range of **identifiers** and **DLCs** may be implemented.

&#8194;&#8195;若 LLC 子层限制了 ID 范围，例如只支持 11 bit CAN-ID，则意味着只有携带受限 CAN-ID 的 LLC DFs 或 RFs（IDE 置 0）可被传输 / 接收.

&#8194;&#8195;若 LLC 子层限制了 DLC 范围，例如支持的 DLC 小于 CAN 帧规定的最大值，则在 LLC DF 中超出限制的数据字节应被填充（padding）；CAN 节点也可能会配置对超出 DLC 规定范围的帧不进行传输.

>* &#8194;The padding of the data field of received DFs does not need to be implemented in the LLC layer.

### 3.4.5 &#8194;Services of LLC sub-layer

#### 3.4.5.1 &#8194;Service access points

>&#8194;&#8195;In CAN nodes, the LLC's service access point is the LLC storage unit, e.g. a memory buffer for the transmission or for the reception of a DF or RF.

#### 3.4.5.2 &#8194;Types of connectionless-mode transmission service

>&#8194;&#8195;The LLC sub-layer shall offer two types of connectionless-mode transmission service
>
>&#8194;&#8194;&#8195;1. Unacknowledged data transfer service: this service provides means by which LLC users exchange LSDU without establishing a data link connection.
>
>&#8194;&#8194;&#8195;2. Unacknowledged remote data request service: this service provides means used by an LLC user to request a remote node for an LSDU transmission without establishing a data link connection.

&#8194;&#8195;远端节点有两种方式来为数据请求提供服务： 请求数据可能已由远程节点准备好传输，即此时数据位于节点缓存区内，收到 RF 时进行传输；请求数据由远程节点在接收到 RF 之后传输。

>&#8194;&#8195;According to the two different LLC services,seven types of frames may be used for the communication between transmitting node and receiving nodes:
>
>&#8194;&#8194;&#8195;- LLC DF in CBFF
>
>&#8194;&#8194;&#8195;- LLC DF in CEFF
>
>&#8194;&#8194;&#8195;- LLC DF in FBFF
>
>&#8194;&#8194;&#8195;- LLC DF in FEFF
>
>&#8194;&#8194;&#8195;- LLC RF in CBFF
>
>&#8194;&#8194;&#8195;- LLC RF in CEFF
>
>&#8194;&#8194;&#8195;- LLC DF in XLFF

#### 3.4.5.3 &#8194;Service specification

&#8194;&#8195;**服务是各层向其上层提供的一组原语**，确定了其能为上一层提供的功能，以定义两层之间的接口。

&#8194;&#8195;服务原语格式如下：

```
      service.type(
          [parameter1,]
      )
```

>&#8194;&#8195;**service** indicates the name of the service, e.g. L_Data for data transfer;
>
>&#8194;&#8195;**type** indicates the type of the service primitives;
>
>&#8194;&#8195;**[parameter1,]** is the list of values passed to the service primitives. (The list can be empty.)

*  &#8194;**LLC Unacknowledged data transfer service**

&#8194;&#8195;&#8195;The same as Unacknowledged remote data transfer service. (以下 L_Data 改为 L_Remote)

| Services | Description |
| --- | --- |
| L_Data.Request | Request for data transfer |
| L_Data.AbortRequest | Request abortion of data transfer |
| L_Data.Confirm | Confirmation of data transfer request |
| L_Data.Indication | Indication of data transfer reception |

*  &#8194;**LLC service parameters**

| Parameter | Description |
| --- | --- |
| Frame | LLC frame |
| Transfer_Status | Confirmation: ongoing, lost arbitration, transmitted, aborted, disturbed |
| Timestamp | Time value captured on trigger from MAC sub-layer |
| Handle | Identifies LLC storage unit used for transaction |

##### 3.4.5.3.1 &#8194;L_Data.Request

>&#8194;&#8195;The L_Data.Request service shall be passed from the LLC user to the LLC sub-layer to request that an LLC frame is sent to one or more remote LLC entities.

```
   L_Data.Request(
          Frame
          Handle
          )
```
>&#8194;&#8195;The LLC storage unit to be used for the transmission is identified by the handle.
>
>&#8194;&#8195;Receipt of this service shall cause the LLC sub-layer to initiate the transfer of an LLC frame by use of the data transfer service provided by the MAC sub-layer. Any L_Data.Request shall be processed not later than the second SOF after the request when there are no EFs presentduring this time.

##### 3.4.5.3.2 &#8194;L_Data.AbortRequest

>&#8194;&#8195;The L_Data.AbortRequest service shall be passed from the LLC user to the LLC sub-layer to abort a previous request of an LLC frame transmission.

```
   L_Data.AbortRequest(
          Handle
          )
```

>&#8194;&#8195;The LLC storage unit for which the transmission shall be aborted is identified by the handle.
>
>&#8194;&#8195;The LLC sub-layer cannot abort transmissions that are already submitted to the MAC sub-layer (due to priority scheduling of the requested LLC storage unit indicated by the handle).
>
>&#8194;&#8195;Any L_Data.AbortRequest shall be processed prior to the second SOF after the request when there are no EFs present during this time.
>
>&#8194;&#8195;Any L_Data.AbortRequest shall be processed prior to the third SOF after the request when there are EFs present during this time.

>* &#8194;Pending transmissions, which are already passed to the MAC sub-layer, shall only be aborted if:
>
>&#8194;&#8194;&#8195;- an error in the MAC sub-layer during transmission occurs, or
>
>&#8194;&#8194;&#8195;- arbitration was lost in the MAC sub-layer, which causes the LLC frame to wait for another transmission attempt.
>
>&#8194;&#8195;This means that an abortion request shall be kept pending in the LLC layer until either one of the above situations occur, or until the transmission was completed.

##### 3.4.5.3.3 &#8194;L_Data.Confirm

>&#8194;&#8195;The L_Data.Confirm service shall be passed from the local LLC sub-layer to the LLC user to convey the results of the previous L_Data.Request service.

```
   L_Data.Confirm(
          Transfer_Status
          Timestamp
          Handle
          )
```

>&#8194;&#8195;The time-stamp is a 64-bit value, captured at one time reference point synchronized to MAC frame transmission. The time-stamp is valid when the Transfer_Status is transmitted. Otherwise,the time-stamp value is undefined.

##### 3.4.5.3.4 &#8194;L_Data.Indication

>&#8194;&#8195;The L_Data.Indication service shall be passed from the LLC sub-layer to the LLC user to indicate the arrival of the data of an LLC frame after the reception of a MAC frame.

```
   L_Data.Indication(
          Frame
          Timestamp
          )
```

### 3.4.6 &#8194;Functions of the LLC sub-layer

>&#8194;&#8195;The LLC sub-layer provides the following functions:
>
>&#8194;&#8194;&#8195;- Flow control;
>
>&#8194;&#8194;&#8195;- Frame acceptance filtering;
>
>&#8194;&#8194;&#8195;- Overload notification;
>
>&#8194;&#8194;&#8195;- Recovery management;
>
>&#8194;&#8194;&#8195;- Time-stamping.

#### 3.4.6.1 &#8194;Flow control on re-arbitration

>&#8194;&#8195;The transmission of frames losing bus arbitration shall be restarted by the LLC entity unless the transmission of that frame is aborted by the LLC user. The restart of the transmission after the loss of arbitration is called a re-arbitration. 

#### 3.4.6.2 &#8194;Flow control on retransmission

>&#8194;&#8195;The restart of the unsuccessful transmission, except after the loss of arbitration, is called a retransmission. The retransmission of frames that are not aborted by the LLC user shall be attempted for the configured specific number of times. Retransmission attempts shall be counted in the retransmission counter. 
>
>&#8194;&#8195;The node's retransmission counter shall be reset to zero when a transmission is successful or when the LLC user requests a new transmission. 
>
>&#8194;&#8195;**Nodes that do not support the XL frame format are not required to implement the retransmission counter, but they shall support unlimited retransmissions.**

#### 3.4.6.3 &#8194;Frame acceptance filtering

>&#8194;&#8195;Each receiver should decide by frame acceptance filtering whether the frame is relevant or not.

&#8194;&#8195;CAN-ID 不代表节点的地址，而是和报文的内容有关，所以节点根据 CAN-ID 决定是否需要接收该报文；

&#8194;&#8195;以 STM32 CAN 控制器为例，每个过滤器组由两个 32 位寄存器（CAN_FxR0 和 CAN_FxR1）组成，且根据所需位宽的不同，可配置成 16 位或 32 位模式。

&#8194;&#8195;过滤器模式可配置成掩码模式或列表模式（ FBMx = 0 为掩码模式， FBMx = 1为列表模式）

&#8194;&#8194;&#8195;**- 掩码模式（屏蔽位模式）：** 该模式下，标识符寄存器和掩码寄存器一起作用，指定接收报文 ID 的任何一位，按照“必须匹配”或“不用关心”处理，**通常用于匹配一组 CAN-ID**；

&#8194;&#8194;&#8194;&#8195;**示例：** 

```
     标识符寄存器： 11 0001 0110

     掩码寄存器： 11 0001 0111

     则计算结果为： 11 xxx1 x110
```

&#8194;&#8194;&#8194;&#8195;匹配以上结果的 CAN-ID 报文均可通过过滤器，其中，x 表示不关心匹配的是 0 还是 1。

&#8194;&#8194;&#8195;**- 列表模式：** 该模式下，掩码寄存器也被当做标识符寄存器使用，即通过两个标识符寄存器，接收报文 ID 的每一位都必须与过滤器标识符相同，**通常用于匹配某个 CAN-ID**；

&#8194;&#8194;&#8194;&#8195;**示例：** 

```
     标识符寄存器： 11 0001 0110

     标识符寄存器： 11 0001 0111

     则支持匹配的 CAN-ID 仅有以上两个： 11 0001 0110 & 11 0001 0111
```

&#8194;&#8195;对于下图四种应用模式，个人理解为：

&#8194;&#8194;&#8195;- 标识符寄存器与掩码寄存器间可视为串联模式，即对于第一与第三场景，过滤器至多支持的 CAN-ID 分别为一组和两组；

&#8194;&#8194;&#8195;- 标识符寄存器与标识符寄存器间可视为并联模式，即对于第二与第四场景，过滤器至多支持的 CAN-ID 分别为两个和四个；

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-STM32_filter.png width="640px">

* &#8194;从实际项目来看，在总线上对 CAN 节点发送任意 0x0 ~ 0x7FF CAN-ID 报文，并不会引发错误帧；

&#8194;&#8195;&#8195;个人看法：过滤器位于 LLC 子层，但错误处理及接收操作都是由 MAC 层和物理层去完成的，所以总线上表现出任意 CAN 帧都被接收，但实际 CAN-ID 会在 LLC 层过滤掉而不会往上传输；

* &#8194;对于网络管理，当 CAN 节点休眠时，只接收指定 CAN-ID 的唤醒报文（否则会出现错误帧），但从 Autosar 开发模块图示来看，网络管理似乎是独立模块而没有涉及到 CAN Filter 。

#### 3.4.6.4 &#8194;Overload notification

>&#8194;&#8195;The transmission of a OF shall be initiated by the LLC sub-layer ifinternal conditions of a receiver require delay of the next LLC DF or LLC RF. 
>
>&#8194;&#8195;If there are internal conditions of a CAN node that cause a OF to be initiated,these conditions shall be documented for that CAN node. **In this case, the CAN node shall not generate more than two OFs.**

#### 3.4.6.5 &#8194;Recovery management

>&#8194;&#8195;The LLC sub-layer's transmission service shall report the Transfer_Status of a requested transmission as Ongoing when the MAC has started that transmission.
>
>&#8194;&#8195;It shall report the Transfer_Status as Transmitted when that transmission is successfully completed.
>
>&#8194;&#8195;It shall report the Transfer_Status as Lost_Arbitration when that transmission loses the bus arbitration, until the frame is started again or aborted.
>
>&#8194;&#8195;It shall report the Transfer_Status as Disturbed when that transmission is disturbed by an error or is not acknowledged, until the frame is started again or aborted.
>
>&#8194;&#8195;It shall report the Transfer_Status as Aborted when that transmission is not successful and is not retransmitted because the frame is aborted, or its retransmission limit is reached.

#### 3.4.6.6 &#8194;Time stamping

>&#8194;&#8195;For the capturing of time stamps, the LLC may provide a cross-layer function interface to a time-base that is outside the DLL. The time-base and time-stamps shall have a length of 64 bit. When time-stamping is not supported, time-base and time-stamps shall be treated as constants with the value 0.
>
>&#8194;&#8195;The time-base shall be captured at time reference points signalled by the MAC sub-layer (see [4.5.3](#453-time-reference-points)); the captured values shall be reported as time-stamps by the services L_Data.Confirm and L_Data.Indication.
>
>&#8194;&#8195;It shall be configurable whether the time reference point at the SOF recognition or at the position when the frame gets valid shall be used for capturing.
>
>&#8194;&#8195;For the service L_Data.Confirm, a time-stamp shall be captured at the time reference point of the transmission of the MAC frame.
>
>&#8194;&#8195;For the service L_Data.Indication, a time-stamp shall be captured at the time reference point of the reception of the MAC frame.

## 3.6 &#8194;MAC sub-layer

### 3.6.1 &#8194;Functions and rules

>&#8194;&#8195;The MAC sub-layer services the interface to the LLC sub-layer and the PMA, and comprises the functions and rules related to:
>
>&#8194;&#8194;&#8195;- encapsulation / decapsulation of the transmit / receive data;
>
>&#8194;&#8194;&#8195;- error detection and signalling;
>
>&#8194;&#8194;&#8195;- management ofthe transmit / receive;

### 3.6.2 &#8194;Services of the MAC sub-layer

>&#8194;&#8195;The MAC sub-layer shall provide services to the local LLC for: 
>
>&#8194;&#8194;&#8195;- (MAC-)acknowledged transfer of LLC frames; 
>
>&#8194;&#8194;&#8195;- time reference points synchronized to MAC frame reception; 
>
>&#8194;&#8194;&#8195;- time reference points synchronized to MAC frame transmission; 
>
>&#8194;&#8194;&#8195;- (MAC-)acknowledged transfer of OFs.

### 3.6.3 &#8194;Time reference points

>&#8194;&#8195;Any DF or RF received or transmitted by the MAC sub-layer shall cause a notification to be sent from the MAC sub-layer to the LLC sub-layer to signal a time reference point for the capture of the time-base as a time-stamp.
>
>&#8194;&#8195;Time reference points shall be signalled both at the sample point ofthe SOF bit and at the sample point of the bit ofthe frame when that frame gets valid.

### 3.6.4 &#8194;Functional model of MAC sub-layer architecture

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-MAC_Function.png width="420px">

### 3.6.5 &#8194;CAN Frame Specification

&#8194;&#8195;CAN Frame 类型主要包括以下：  

&#8194;&#8194;&#8195;1. **Data Frame 数据帧**: 携带从发送节点至接收节点的数据，包括**标准数据帧**及**扩展数据帧**两种形式； 

&#8194;&#8194;&#8195;2. **Remote Frame 远程帧**: 向其他节点请求发送具有同一 CAN-ID 的数据帧；  

&#8194;&#8194;&#8195;3. **Error Frame 错误帧**: 节点检测到错误后发送错误帧；  

&#8194;&#8194;&#8195;4. **Overload Frame 超载帧**: 节点检测到过载条件时发送，在先行及后续的 DF（或 RF）之间附加一段延时；  

&#8194;&#8194;&#8195;5. **ITM / Intermission 帧间隔 （或称 IFS /Interframe Space 帧间空间）**: DF（或 RF）通过帧间隔与上述各类帧进行分隔，但在错误帧和过载帧前不会插入帧间隔（严格讲并不算作一种帧类型）；

* &#8194; Classical CAN 与 CAN FD 均采用两种类型的数据帧格式：具有11位标识符的标准帧和具有29位标识符的扩展帧。这可确保对 CAN FD 进行部分调整后即可使用 CANopen 和 SAE J1939 等基于 CAN 的高层协议。

* &#8194; CAN FD 没有为远程帧定义单独的格式，远程帧没有数据场，因此提高传输速率没有作用。所以，CAN FD 协议允许 Classical CAN 远程帧请求 CAN FD 帧。

* &#8194; CAN FD 控制器可以发送和接收 Classical CAN 帧以及 CAN FD 帧，但 Classical CAN 控制器接收到 CAN FD 帧时将始终使用错误帧进行响应。

#### 3.6.5.1 &#8194;Data Frame

##### 3.6.5.1.1 &#8194;Data Frame Standard Format

<img src="https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Standard_Format_Data_Frame.png" width="720px">

###### 3.6.5.1.1.1 &#8194;Start Of Frame

&#8194;&#8195;- **SOF / Start of Frame / 帧起始**：1 bit，SOF 是数据帧（或远程帧）传输的起始位。发送方会发送一个显性电平作为 SOF ，由于总线空闲时总线会保持隐性电平，因此 SOF 发出后会产生一个跳变沿（从 1 到 0 ）用于整个 CAN 网络的时间同步。为了在帧传输期间保持与发送方的同步，接收方会对所有隐性电平到显性电平的跳变沿进行是否与发送方保持同步的判断（硬同步），如果出现偏差，接收方将按照相关相位误差量重新进行同步（重同步）；

###### 3.6.5.1.1.2 &#8194;Arbitration Field

&#8194;&#8195;- **ID / Identifier / 标识符**： 11 bit （0x0 up to 0x7FF hexadecimal），用于区分数据帧的优先级，并根据通信矩阵中定义的收发关系为节点中的接收过滤器提供过滤依据；

&#8194;&#8195;- **RTR / Remote Transmission Request / 远程传输请求位**： 1 bit，发送方将其用于通知接收方帧的类型（数据帧或远程帧）。RTR 位为显性（逻辑 0）表示数据帧，隐性（逻辑 1）则表示远程帧；

###### 3.6.5.1.1.3 &#8194;Control Field

&#8194;&#8195;- **IDE / Identifier Extension bit / 标识符扩展位**： 1 bit，IDE 位用于区分标准格式和扩展格式。显性为标准 ID 有 11 位，隐性为扩展 ID 有 29 位；

&#8194;&#8195;- **r**: 1bit，作为保留位， Classical CAN 中未定义其内容，在指定保留位的功能之前，一般置为显性位；

&#8194;&#8195;- **DLC / Data Length Code / 数据长度代码**： 4 bit，DLC 表示数据场中的有效负载的字节数，一个 Classical CAN 数据帧最多可以传输八个字节；

###### 3.6.5.1.1.4 &#8194;Date Field

&#8194;&#8195;- **Data Field / 数据场**： 64 bit，数据内容，一帧可发送 0 ~ 8 个字节的数据，MSB先发，其中：   
&#8194;&#8195;&#8195;DLC 为 0 ~ 8 ： 对应数据场的实际字节数；  
&#8194;&#8195;&#8195;DLC 为 9 ~ 15 ： 8 字节数据；

###### 3.5.5.1.1.5 &#8194;CRC Field

&#8194;&#8195;- **CRC sequence/ cyclic redundancy check sequence/ 循环冗余校验码**： 15 bit，发送方计算 SOF ~ Data Field 的 CRC 校验值（CRC_TX）；接收方使用相同算法进行 CRC_RX 计算，并完成 CRC_RX 与 CRC_TX 的对比，并确认是否一致；

&#8194;&#8195;- **DEL / CRC delimiter / CRC 界定符**： 1 bit，隐性位表示；

###### 3.6.5.1.1.6 &#8194;ACK field

&#8194;&#8195;- **ACK slot / Acknowledgement slot**： 1 bit，所有匹配 CRC sequence （CRC Pass） 的接收节点都应在 ACK slot 内通过用显性位覆盖发送方的隐性位来发送 ACK，即发送方的 ACK 位实际由接收方的 ACK 返回值决定，其中：  

&#8194;&#8195;&#8195;ACK on bus = 0 -> message transmitted correctly reception by at least one without error;  

&#8194;&#8195;&#8195;ACK on bus = 1 -> transmission error occurred or no receiver at all;

&#8194;&#8195;- **DEL / ACK delimiter / ACK 界定符**： 1 bit，隐性位表示；

###### 3.6.5.1.1.7 &#8194;End Of Frame

&#8194;&#8195;- **EOF**： EOF 由 7 个连续隐性位组成，在此之后，报文传输结束；

##### 3.6.5.1.2 &#8194;Data Frame Exteded Format

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Data_Frame.png)

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Extended_Format_Data_Frame.png)

&#8194;&#8195;扩展数据帧与标准数据帧的主要区别在于：  

&#8194;&#8194;&#8195;1. 扩展数据帧支持 29（11 + 18） bit 的 CAN-ID，即 0x00000000 up to 0x1FFFFFFF，以此扩展更多的 CAN 节点；  

&#8194;&#8194;&#8195;2. 仲裁场中包含一个 SRR (Substitute Remote Request / 替代远程请求) 位，以隐性位发送；  

&#8194;&#8194;&#8195;3. IDE 位为隐性；  

&#8194;&#8194;&#8195;4. 支持两个保留位 r0 和 r1，一般以显性位发送；

&#8194;&#8195;**Q - 关于为何设置 SRR 位的个人想法如下：**  
&#8194;&#8195;在前 11 bit CAN-ID 完全一致的情况下，对比随后 2 bit 状态 —— 标准数据/远程帧为 RTR + IDE & 扩展数据帧/远程帧为 SRR + IDE：  

&#8194;&#8194;&#8195; - 标准数据帧为： 0 + 0;  

&#8194;&#8194;&#8195; - 标准远程帧为： 1 + 0;  

&#8194;&#8194;&#8195; - 扩展数据帧为： 1 + 1;（若扩展帧也采用 RTR + IDE 的形式则为 0 + 1）  

&#8194;&#8194;&#8195; - 扩展远程帧为： 1 + 1;  

&#8194;&#8195;从上述结论看，SRR 位确保了标准远程帧的优先级高于扩展数据帧。


* &#8194;用于卡车及客车的 SAE 1939 协议通常是 18xx xxxx 的 CAN-ID;

#### 3.6.5.2 &#8194;Remote Frame

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Remote_Frame.png)

&#8194;&#8195;通常，数据传输由数据源节点（e.g. 传感器发出数据帧）自主完成。但也可能存在目标节点向源节点请求发送数据的情况。为此，目标节点需发送一个远程帧，其中的 CAN-ID 应与所需数据帧的标识符相匹配。随后，相应的数据源节点会发送一个数据帧以响应远程帧请求
；  
&#8194;&#8195;远程帧与数据帧的区别在于其不携带 Date Field，且 RTR 位为隐性状态，其他内容则完全一致；  

&#8194;&#8195;远程帧同样分为**标准远程帧**和**扩展远程帧**，格式可参考数据帧部分；

#### 3.6.5.3 &#8194;Error Frame

<img src="https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Frame.png" width="320px">

<img src="https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Active_Node.png" width="550px">

<img src="https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Passtive_Node.png" width="550px">

&#8194;&#8195;**Error Frame = Error Flag (Active / Passtive) + Error Delimiter**  

&#8194;&#8195;**Active Error Flag = 连续 6 个显性位；**  

&#8194;&#8195;**Passtive Error Flag = 连续 6 个隐性位；**  

&#8194;&#8195;**Error Delimiter = 连续 8 个隐性位；**

* &#8194;对于主动错误节点来说，由于显性覆盖隐性的规则，当多个节点发送主动错误帧时，总线上可能会出现如上图所示的 <错误标志重叠部分> 范围为 0~6 个显性位，即最多出现连续 12 个显性位；

#### 3.6.5.4 &#8194;Overload Frame

<img src="https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Overload_Frame.png" width="280px">

&#8194;&#8195;协议描述： [4.4.6.4 Overload notification](#4464-overload-notification)

&#8194;&#8195;**Overload Frame = Overload Flag("000000") + Overload Delimiter**  

&#8194;&#8195;即过载帧的构成与主动错误帧完全一致；

&#8194;&#8195;**Q 过载帧和主动错误帧如何区分？**  

&#8194;&#8195;根据一般说法，节点在以下两种情况下会产生过载帧：  

&#8194;&#8194;&#8195;1. 节点在帧间隔的第一位和第二位检测到非法显性位，意味着此刻有其他节点在发送数据，因此会发送过载帧；（ITM 第三位为显性可能是由于晶帧影响，CAN 接收器会将其视为 SOF）

&#8194;&#8194;&#8195;2. 接收方由于某种原因需要延迟接收下一个数据帧或远程帧，此时，过载标志的6个连续显性位会屏蔽掉总线上其它节点的数据发送以达到推迟接收的目的；

&#8194;&#8195;依此，从节点角度考虑，区分主要分为两方面，其一是出现时机，和错误帧不同，过载帧通常会在非数据传输过程中出现；另一方面过载帧不会导致 CAN 节点内错误计数器增加。

#### 3.6.5.5 &#8194;ITM / IFS

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-ITM_Frame.png)

&#8194;&#8195;数据帧（或远程帧）通过插入帧间隔可以将本帧与先行帧（数据帧、远程帧、错误帧、过载帧）分隔开来；  

&#8194;&#8195;错误帧和过载帧前不能插入帧间隔；  

&#8194;&#8195;帧间隔过后，如果无节点发送帧，则总线进入空闲；由上图可知，实际场景下，**当检测到连续 11 个隐性位后，判定总线进入空闲状态**；（个人看法： 可能这也是为什么错误界定符以及过载界定符设定为连续 8 个隐性位原因，其加上 3 位隐性，正好为连续 11 位隐性）

&#8194;&#8195;帧间隔过后，如果被动错误节点要发送帧，则先发送 8 个隐性电平的传输延迟，再发送帧（保证主动错误节点优先发送，避免被动错误节点因硬件故障干扰整个网络）。

## 5 &#8194;CAN Physical-Layer Specification



## 6 &#8194;Description of supervisor FCE
