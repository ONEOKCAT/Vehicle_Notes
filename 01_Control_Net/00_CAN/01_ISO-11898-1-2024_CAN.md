## 1 &#8194;Intro

>&#8194;&#8195;ISO 11898-1 定义了 CAN Data Link Layer（**DLL**，分为 LLC 及 MAC 两部分）以及 Physical Coding Sub-layer（PCS，位于 **PL** - Physical Layer）；  
&#8194;&#8195;DLL 利用 service data unit (**SDU** 即 **LLC Frame**）以链接 LLC 和 MAC，且 LLC Frame 还具有 service data unit type (**SDT**) and the virtual CAN
channel identifier (**VCID**)，提供了更高层的协议配置和标识信息；  
&#8194;&#8195;ISO 11898-1: 2024 提供了以下五种节点选项：  
&#8194;&#8194;&#8195;1. support ofthe CAN classic frame format only,not tolerating the CAN flexible data rate(FD)frame format;  
&#8194;&#8194;&#8195;2. support ofthe CAN classic frame format and tolerating the CAN FD frame format;  
&#8194;&#8194;&#8195;3. support ofthe CAN classic frame format and the CAN FD frame format;  
&#8194;&#8194;&#8195;4. support ofthe CAN classic frame format,the CAN FD frame format andthe CAN XL frame format;  
&#8194;&#8194;&#8195;5. support ofthe CAN FD frame format for CAN FD light responders.

>* &#8194;选项 1 节点可与选项 3 和 4 节点进行通信，但无法和选项 5 节点通信（任何通信尝试都会产生错误帧）；
>* &#8194;选项 4 节点可与所有类型节点通信。

### 1.1 &#8194;CAN Type

&#8194;&#8195;**CAN**: 又被称为 Classical CAN。  
&#8194;&#8195;**CAN-FD**（Flexible Data-Rate）: 为克服传统 CAN 协议的带宽限制，CAN-FD 允许更高的数据传输速率和更大的数据帧，提供了更灵活的数据传输选项；    
&#8194;&#8195;**CAN-XL**（Extended Length）: 作为 CAN-FD 的进一步扩展，旨在进一步增加数据传输速率和灵活性，支持更大的数据帧和更高的传输速率；  
&#8194;&#8195;ISO-11898-1: 2024 中定义了五种 CAN Type：  
&#8194;&#8194;&#8195;1. **CBFF** : Classical Base Frame Format  
&#8194;&#8194;&#8195;2. **CEFF** : Classical Extended Frame Format  
&#8194;&#8194;&#8195;3. **FBFF** : FD Base Frame Format  
&#8194;&#8194;&#8195;4. **FEDD** : FD Extended Frame Format  
&#8194;&#8194;&#8195;5. **XLDD** : XL Frame Format  

## 2 &#8194;Basic concepts of CAN

### 2.1 &#8194;CAN properties

>&#8194;&#8195;**1. Multi-master priority-based bus access;**  
>&#8194;&#8195;**2. Non-destructive content-based arbitration;** # [2.2](#22-frame-transmissions)  
>&#8194;&#8195;**3. All frame transfers are done as broadcast;**  
>&#8194;&#8195;**4. Multicast frame transfer by acceptance filtering;** # [2.5](#25-information-routing)  
>&#8194;&#8195;**5. Remote data request;** # [2.6](#26-remote-data-request)  
>&#8194;&#8195;**6. Configuration flexibility;** # [2.4](#24-network-flexibility)  
>&#8194;&#8195;**7. Error detection and error signalling;** # [2.7](#27-Error-detection) # [2.8](#28-Error-signalling-and-recovery-time) # [2.9](#29-Fault-confinement) # [2.10](#210-Error-active) # [2.11](#211-Error-passive) # [2.12](#212-Bus-off)  
>&#8194;&#8195;**8. Retransmission of frames that lose bus arbitration, are not acknowledged, or are invalided by errors;** # [2.14](#214-Repetition-of-transmission)  
>&#8194;&#8195;**9. Network-wide data consistency.** # [2.15](#215-Network-wide-data-consistency)

>* &#8194;The following properties can be omitted by configuration: retransmission, error signalling, network-wide data consistency and remote data request. 

&#8194;&#8195;ISO 11898-1 定义了多主架构，以确保高可用性和事件驱动的数据传输；CAN 网络中的每个节点都有权访问 CAN 总线，无需请求许可，也无需事先与其他 CAN 节点进行协调。虽然基于事件驱动的总线访问对事件的响应非常快，但也存在风险，即多个 CAN 节点可能同时访问 CAN 总线，从而导致 CAN 总线上出现数据重叠。

### 2.2 &#8194;Frame transmissions

>&#8194;&#8195;The DLL sends different frames: data frames (DF), remote frames (RF), error frames (EF) and overload frames (OF).

&#8194;&#8195;CAN-Bus 的空闲状态意味着总线上无任何帧传输，此时 CAN 节点可以开始 DF 或 RF 的传输；当节点检测到错误条件或过载条件时，将会发送 EF 或 OF。

### 2.3 &#8194;Bus access method

&#8194;&#8195;原则上，CAN-Bus 访问采用“先到先得”机制，即先发送的帧具有更高优先级；若多个节点同时传输 DF 或 RF，将通过非破坏性仲裁机制，其本质是使用标识符（CAN-ID 越小，优先级越高）来解决总线访问冲突。

>* &#8194;The mechanism of arbitration ensures that neither information nor time is lost.
>* &#8194;A DF with the same ID as an RF wins.

### 2.4 &#8194;Network flexibility

>&#8194;&#8195;Nodes can be added to the network without requiring any change in the software or hardware of any node, if the added node is not the transmitter of any DF and if the added node does not require any additional transmitted data.

### 2.5 &#8194;Information routing

&#8194;&#8195;所谓帧接收过滤，指的是节点有权决定接收数据与否，从而实现仅接收与其相关的信息；此外，接收节点无需知晓数据的发送方，反之亦然。

### 2.6 &#8194;Remote data request

>&#8194;&#8195;By sending an RF, a node requiring data requestsanother node to send the corresponding DF: the RF and the corresponding DF are named by the same identifier and using the same DLC.

&#8194;&#8195;CAN 节点可以使用 RF （不携带数据部分）来请求其他节点响应具有相同 CAN-ID 和 DLC 的 DF；  
&#8194;&#8195;原则上，可以为 CAN 网络中的所有数据帧定义远程帧，仅需确保远程帧的标识符与所关联数据帧的ID匹配，发送节点通过发送数据帧来响应远程帧；  
&#8194;&#8195;但 RF 实际应用较少，基本无。

### 2.7 &#8194;Error detection

>&#8194;&#8195;- Monitoring (transmitters comparethe transmitted bit levels with the bit levels detected on thenetwork);  
&#8194;&#8195;&#8195;- 通过 CRC Field 实现；  
&#8194;&#8195;- Fixed bit stuffing with a stuffrate of 5 (used in the FD CRC field);  
&#8194;&#8195;- Fixed bit stuffing with a stuffrate of 11 (used in the XL data phase);  
&#8194;&#8195;- Frame format check;  
&#8194;&#8195;- ACK check.

### 2.8 &#8194;Error signalling and recovery time

>&#8194;&#8195;Corrupted frames are flagged by transmitting nodes and by error-active receiving nodes. Such frames are
aborted and retransmitted according to the implemented recovery procedure.

### 2.9 &#8194;Fault confinement

>&#8194;&#8195;CAN nodes can distinguish short disturbances from permanent failures. Defective transmitting nodes are switched off. Switched off means a node is logically disconnected from the bus, so that it can neither send nor receive frames.

### 2.10 &#8194;Error-active

>&#8194;&#8195;An error-active node takes part in network communication and sends an active error flag when an error is detected. The active error flag consists of six consecutive dominant bits and violates the rule of bit-stuffing and all fixed formats appearing in a DF and RF.

### 2.11 &#8194;Error-passive

>&#8194;&#8195;An error-passive node sends no active error flag. It takes part in network communication, but when an error is detected a passive error flag is sent. The passive error flag consists of six consecutive recessive bits. After transmission,an error-passive node waits additional time before initiating a further transmission.

### 2.12 &#8194;Bus-off

>&#8194;&#8195;A node is in the bus-off state when it is switched off from the bus due to an FCE （Fault confinement Entity） request. In the bus-off state, a node neither sends nor receives frames. In the bus-off state, a node does not send any dominant bits.  
&#8194;&#8195;- Nodes with disabled error signalling do not enter bus-off state.  
>&#8194;&#8195;- Nodes with disabled error signalling do not enter error-passive state.

### 2.13 &#8194;ACK

>&#8194;&#8195;Receivers check the consistency of the received DFs and RFs, acknowledge a consistent frame and,when error signalling is enabled, flag an inconsistent frame by means of EFs.

### 2.14 &#8194;Repetition of transmission 

>&#8194;&#8195;The number of automatic retransmissions of DFs or RFs that are not transmitted successfully by any reason,except the loss of bus arbitration, can be configurable to a dedicated number. That number can reach from zero tounlimited, while unlimited means that retransmissions are only limited by the error counting mechanisms.

&#8194;&#8195;仲裁失败的 DF 或 RF 将会自动重新参与仲裁。

### 2.15 &#8194;Network-wide data consistency

>&#8194;&#8195;Network configuration decides whether nodessignal the errors detectedin frames. When error signalling is enabled within a network, a frame can be simultaneously accepted as a valid frame either by all nodes or by no node.  
&#8194;&#8195;Thus, data consistency is a property of the network achieved by the concepts of the broadcast and by the error handling. When error signalling is disabled within a network, local errors can prevent specific nodes from receiving frames that are received by other nodes.

## 3 &#8194;CAN Frame Specification

&#8194;&#8195;CAN Frame 类型主要包括以下：  
&#8194;&#8194;&#8195;1. **Data Frame 数据帧**: 携带从发送节点至接收节点的数据，包括**标准数据帧**及**扩展数据帧**两种形式；    
&#8194;&#8194;&#8195;2. **Remote Frame 远程帧**: 向其他节点请求发送具有同一 CAN-ID 的数据帧；  
&#8194;&#8194;&#8195;3. **Error Frame 错误帧**: 节点检测到错误后发送错误帧；  
&#8194;&#8194;&#8195;4. **Overload Frame 超载帧**: 节点检测到过载条件时发送，在先行及后续的 DF（或 RF）之间附加一段延时；  
&#8194;&#8194;&#8195;5. **ITM / Intermission 帧间隔**: DF（或 RF）通过帧间隔与上述各帧进行分隔（严格讲并不算作一种帧类型）；

* &#8194; Classical CAN 与 CAN FD 均采用两种类型的数据帧格式：具有11位标识符的标准帧和具有29位标识符的扩展帧。这可确保对 CAN FD 进行部分调整后即可使用 CANopen 和 SAE J1939 等基于 CAN 的高层协议。

* &#8194; CAN FD 没有为远程帧定义单独的格式，远程帧没有数据场，因此提高传输速率没有作用。所以，CAN FD 协议允许 Classical CAN 远程帧请求 CAN FD 帧。

* &#8194; CAN FD 控制器可以发送和接收 Classical CAN 帧以及 CAN FD 帧，但 Classical CAN 控制器接收到 CAN FD 帧时将始终使用错误帧进行响应。

### 3.1 &#8194;Data Frame

#### 3.1.1 &#8194;Data Frame Standard Format

##### 3.1.1.1 &#8194;Start Of Frame

&#8194;&#8195;- **SOF / Start of Frame / 帧起始**：1 bit，SOF 是数据帧（或远程帧）传输的起始位。发送方会发送一个显性电平作为 SOF ，由于总线空闲时总线会保持隐性电平，因此 SOF 发出后会产生一个跳变沿（从 1 到 0 ）用于整个 CAN 网络的时间同步。为了在帧传输期间保持与发送方的同步，接收方会对所有隐性电平到显性电平的跳变沿进行是否与发送方保持同步的判断（硬同步），如果出现偏差，接收方将按照相关相位误差量重新进行同步（重同步）；

##### 3.1.1.2 &#8194;Arbitration Field

&#8194;&#8195;- **ID / Identifier / 标识符**： 11 bit，用于区分数据帧的优先级，并根据通信矩阵中定义的收发关系为节点中的接收过滤器提供过滤依据；

&#8194;&#8195;- **RTR / Remote Transmission Request / 远程传输请求位**： 1 bit，发送方将其用于通知接收方帧的类型（数据帧或远程帧）。RTR 位为显性（逻辑 0）表示数据帧，隐性（逻辑 1）则表示远程帧；

##### 3.1.1.3 &#8194;Control Field

&#8194;&#8195;- **IDE / Identifier Extension bit / 标识符扩展位**： 1 bit，IDE 位用于区分标准格式和扩展格式。标准 ID 有 11 位，扩展 ID 有 29 位；

&#8194;&#8195;- **r**: 1bit，作为保留位， Classical CAN 中未定义其内容，在指定保留位的功能之前，一般置为显性位；

&#8194;&#8195;- **DLC / Data Length Code / 数据长度代码**： 4 bit，DLC 表示数据场中的有效负载的字节数，一个 Classical CAN 数据帧最多可以传输八个字节；

##### 3.1.1.4 &#8194;Date Field

&#8194;&#8195;- **Data Field / 数据场**： 64 bit，数据内容，一帧可发送 0 ~ 8 个字节的数据，MSB先发，其中：   
&#8194;&#8195;&#8195;DLC 为 0 ~ 8 ： 对应数据场的实际字节数；  
&#8194;&#8195;&#8195;DLC 为 9 ~ 15 ： 8 字节数据；

---- DLC 对应 Data -----

##### 3.1.1.5 &#8194;CRC Field

&#8194;&#8195;- **CRC sequence/ cyclic redundancy check sequence/ 循环冗余校验码**： 15 bit，发送方计算 SOF ~ Data Field 的 CRC 校验值（CRC_TX）；接收方使用相同算法进行 CRC_RX 计算，并完成 CRC_RX 与 CRC_TX 的对比，并确认是否一致；

&#8194;&#8195;- **DEL / CRC delimiter / CRC 界定符**： 1 bit，隐性位表示；

##### 3.1.1.6 &#8194;ACK field

&#8194;&#8195;- **ACK slot / Acknowledgement slot**： 1 bit，所有匹配 CRC sequence （CRC Pass） 的接收节点都应在 ACK slot 内通过用显性位覆盖发送方的隐性位来发送 ACK，即发送方的 ACK 位实际由接收方的 ACK 返回值决定，其中：  
&#8194;&#8195;&#8195;ACK on bus = 0 -> message transmitted correctly reception by at least one without error;  
&#8194;&#8195;&#8195;ACK on bus = 1 -> transmission error occurred or no receiver at all;

&#8194;&#8195;- **DEL / ACK delimiter / ACK 界定符**： 1 bit，隐性位表示；

##### 3.1.1.7 &#8194;End Of Frame & ITM

&#8194;&#8195;- **EOF**： EOF 由 7 个连续隐性位组成，在此之后，报文传输结束；

&#8194;&#8195;- **ITM**： ITM 由 3 个连续隐性位组成，在此之后，允许其他节点访问总线；

#### 3.1.2 &#8194;Data Frame Exteded Format

### 3.2 &#8194;Remote Frame

### 3.3 &#8194;Error Frame

### 3.4 &#8194;Overload Frame

### 3.5 &#8194;Frame Interval

## 4 &#8194;CAN Data-Link-Layer Specification

## 5 &#8194;CAN Physical-Layer Specification

## 6 &#8194;Description of supervisor FCE
