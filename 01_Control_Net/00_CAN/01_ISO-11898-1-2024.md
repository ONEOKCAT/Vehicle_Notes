# 1 &#8194;Intro

>&#8194;&#8195;ISO 11898-1 定义了 CAN Data Link Layer（**DLL**，分为 LLC 及 MAC 两部分）以及 Physical Coding Sub-layer（PCS，位于 **PL** - Physical Layer）；
>
>&#8194;&#8195;DLL 利用 service data unit (**SDU** 即 **LLC Frame**）以链接 LLC 和 MAC，且 LLC Frame 还具有 service data unit type (**SDT**) and the virtual CAN
channel identifier (**VCID**)，提供了更高层的协议配置和标识信息；  
>
>&#8194;&#8195;ISO 11898-1: 2024 提供了以下五种节点选项：
>
>&#8194;&#8194;&#8195;1. support of the CAN classic frame format only,not tolerating the CAN flexible data rate (FD) frame format;
>
>&#8194;&#8194;&#8195;2. support of the CAN classic frame format and tolerating the CAN FD frame format; 
>
>&#8194;&#8194;&#8195;3. support of the CAN classic frame format and the CAN FD frame format;  
>
>&#8194;&#8194;&#8195;4. support of the CAN classic frame format,the CAN FD frame format andthe CAN XL frame format;  
>
>&#8194;&#8194;&#8195;5. support of the CAN FD frame format for CAN FD light responders.
>
>* &#8194;选项 1 节点可与选项 3 和 4 节点进行通信，但无法和选项 5 节点通信（任何通信尝试都会产生错误帧）；
>* &#8194;选项 4 节点可与所有类型节点通信。

## 1.1 &#8194;Terms and definitions

&#8194;&#8195;**arbitration mode**

&#8194;&#8194;&#8195;- operating mode of the physical coding sub-layer (PCS) in which it is allowed that dominant bits can overwrite recessive bits.

&#8194;&#8195;**CBFF** : Classical Base Frame Format

&#8194;&#8194;&#8195;- format for data frames or remote frames using an 11 -  bit identifier and which are transmitted with one single bit rate and up to and including eight data bytes.

&#8194;&#8195;**CEFF** : Classical Extended Frame Format

&#8194;&#8194;&#8195;- format for data frames or remote frames using an 29 - bit identifier and which are transmitted with one single bit rate and up to and including eight data bytes.

&#8194;&#8195;**FBFF** : FD Base Frame Format

&#8194;&#8194;&#8195;- format for data frames using an 11 - bit identifier, which can be transmitted with a flexible bit rate.

&#8194;&#8195;**FEFF** : FD Extended Frame Format

&#8194;&#8194;&#8195;- format for data frames using an 29 - bit identifier, which can be transmitted with a flexible bit rate.

&#8194;&#8195;**XLFF** : XL Frame Format

&#8194;&#8194;&#8195;- format for data frames using an 11 - bit identifier, including up to 2048 data bytes, where the bit rate is switched at the beginning and at the end of the data phase.

# 2 &#8194;Basic concepts of CAN

## 2.1 &#8194;CAN properties

>&#8194;&#8195;**1. Multi-master priority-based bus access;**
>
>&#8194;&#8195;**2. Non-destructive content-based arbitration;** # [2.3](#23-Bus-access-method)
>
>&#8194;&#8195;**3. All frame transfers are done as broadcast;**
>
>&#8194;&#8195;**4. Multicast frame transfer by acceptance filtering;** # [2.5](#25-information-routing)
>
>&#8194;&#8195;**5. Remote data request;** # [2.6](#26-remote-data-request)
>
>&#8194;&#8195;**6. Configuration flexibility;** # [2.4](#24-network-flexibility)
>
>&#8194;&#8195;**7. Error detection and error signalling;** # [2.7](#27-Error-detection) # [2.8](#28-Error-signalling-and-recovery-time) # [2.9](#29-Fault-confinement) # [2.10](#210-Error-active) # [2.11](#211-Error-passive) # [2.12](#212-Bus-off)
>
>&#8194;&#8195;**8. Retransmission of frames that lose bus arbitration, are not acknowledged, or are invalided by errors;** # [2.14](#214-Repetition-of-transmission)
>
>&#8194;&#8195;**9. Network-wide data consistency.** # [2.15](#215-Network-wide-data-consistency)
>
>* &#8194;The following properties can be omitted by configuration: retransmission, error signalling, network-wide data consistency and remote data request. 

&#8194;&#8195;ISO 11898-1 定义了多主架构，以确保高可用性和事件驱动的数据传输；CAN 网络中的每个节点都有权访问 CAN 总线，无需请求许可，也无需事先与其他 CAN 节点进行协调。虽然基于事件驱动的总线访问对事件的响应非常快，但也存在风险，即多个 CAN 节点可能同时访问 CAN 总线，从而导致 CAN 总线上出现数据重叠。

## 2.2 &#8194;Frame transmissions

>&#8194;&#8195;The DLL sends different frames: data frames (DF), remote frames (RF), error frames (EF) and overload frames (OF).

&#8194;&#8195;CAN-Bus 的空闲状态意味着总线上无任何帧传输，此时 CAN 节点可以开始 DF 或 RF 的传输；当节点检测到错误条件或过载条件时，将会发送 EF 或 OF。

## 2.3 &#8194;Bus access method

&#8194;&#8195;原则上，CAN-Bus 访问采用“先到先得”机制，即先发送的帧具有更高优先级；若多个节点同时传输 DF 或 RF，将通过非破坏性仲裁机制，其本质是使用标识符（CAN-ID 越小，优先级越高）来解决总线访问冲突。

>* &#8194;The mechanism of arbitration ensures that neither information nor time is lost.
>
>* &#8194;A DF with the same ID as an RF wins.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Non-destructive_content-based_arbitration.png width="600px">

&#8194;&#8195;**总线访问概述 —— CSMA / CD (Carrier Sense Multiple Access / Collision Detection - 载波侦听多路访问 / 碰撞检测) + AMP (Arbitration On Message priority)**:

&#8194;&#8195;载波侦听 (Carrier Sense) 指任何连接到介质的设备在欲发送帧前，必须对介质进行侦听，当确认其空闲时，才可以发送；多路访问 (Multiple Access) 指多个设备可以同时访问介质，一个设备发送的帧也可以被多个设备接收；碰撞检测 ( Collision Detection / CD ): 载波监听的物理实现，边发送数据边检测信道上电压的变化情况。

## 2.4 &#8194;Network flexibility

>&#8194;&#8195;Nodes can be added to the network without requiring any change in the software or hardware of any node, if the added node is not the transmitter of any DF and if the added node does not require any additional transmitted data.

## 2.5 &#8194;Information routing

&#8194;&#8195;所谓帧接收过滤，指的是节点有权决定接收数据与否，从而实现仅接收与其相关的信息；此外，接收节点无需知晓数据的发送方，反之亦然。

## 2.6 &#8194;Remote data request

>&#8194;&#8195;By sending an RF, a node requiring data requests another node to send the corresponding DF: the RF and the corresponding DF are named by the same identifier and using the same DLC.
>
>&#8194;&#8195;NOTE 1 The node providing the remotely requested DF (same ID) decides whether the updated data is mapped into the DF or the data in the transmit buffer is sent.
>
>&#8194;&#8195;NOTE 2 The node providing the remotely requested DF (same ID) decides how to respond to an RF with mismatching DLC.

&#8194;&#8195;CAN 节点可以使用 RF （不携带数据部分）来请求其他节点响应具有相同 CAN-ID 和 DLC 的 DF；  

&#8194;&#8195;原则上，可以为 CAN 网络中的所有数据帧定义远程帧，仅需确保远程帧的标识符与所关联数据帧的 ID 匹配，发送节点通过发送数据帧来响应远程帧；  

&#8194;&#8195;但 RF 实际应用较少，基本无。

## 2.7 &#8194;Error detection

>&#8194;&#8195;- Monitoring (transmitters comparethe transmitted bit levels with the bit levels detected on thenetwork);

&#8194;&#8195;&#8195;- 通过 CRC Field 实现；  

&#8194;&#8195;- Fixed bit stuffing with a stuffrate of 5 (used in the FD CRC field);  

&#8194;&#8195;- Fixed bit stuffing with a stuffrate of 11 (used in the XL data phase);  

&#8194;&#8195;- Frame format check;  

&#8194;&#8195;- ACK check.

## 2.8 &#8194;Error signalling and recovery time

>&#8194;&#8195;Corrupted frames are flagged by transmitting nodes and by error-active receiving nodes. Such frames are
aborted and retransmitted according to the implemented recovery procedure.

## 2.9 &#8194;Fault confinement

>&#8194;&#8195;CAN nodes can distinguish short disturbances from permanent failures. Defective transmitting nodes are switched off. Switched off means a node is logically disconnected from the bus, so that it can neither send nor receive frames.

## 2.10 &#8194;Error-active

>&#8194;&#8195;An error-active node takes part in network communication and sends an active error flag when an error is detected. The active error flag consists of six consecutive dominant bits and violates the rule of bit-stuffing and all fixed formats appearing in a DF and RF.

## 2.11 &#8194;Error-passive

>&#8194;&#8195;An error-passive node sends no active error flag. It takes part in network communication, but when an error is detected a passive error flag is sent. The passive error flag consists of six consecutive recessive bits. After transmission,an error-passive node waits additional time before initiating a further transmission.

## 2.12 &#8194;Bus-off

>&#8194;&#8195;A node is in the bus-off state when it is switched off from the bus due to an FCE （Fault confinement Entity） request. In the bus-off state, a node neither sends nor receives frames. In the bus-off state, a node does not send any dominant bits.
>
>&#8194;&#8195;- Nodes with disabled error signalling do not enter bus-off state.  
>
>&#8194;&#8195;- Nodes with disabled error signalling do not enter error-passive state.

## 2.13 &#8194;ACK

>&#8194;&#8195;Receivers check the consistency of the received DFs and RFs, acknowledge a consistent frame and,when error signalling is enabled, flag an inconsistent frame by means of EFs.

## 2.14 &#8194;Repetition of transmission 

>&#8194;&#8195;The number of automatic retransmissions of DFs or RFs that are not transmitted successfully by any reason,except the loss of bus arbitration, can be configurable to a dedicated number. That number can reach from zero tounlimited, while unlimited means that retransmissions are only limited by the error counting mechanisms.

&#8194;&#8195;仲裁失败的 DF 或 RF 将会自动重新参与仲裁。

## 2.15 &#8194;Network-wide data consistency

>&#8194;&#8195;Network configuration decides whether nodessignal the errors detectedin frames. When error signalling is enabled within a network, a frame can be simultaneously accepted as a valid frame either by all nodes or by no node.
>
>&#8194;&#8195;Thus, data consistency is a property of the network achieved by the concepts of the broadcast and by the error handling. When error signalling is disabled within a network, local errors can prevent specific nodes from receiving frames that are received by other nodes.

## 2.16 &#8194;Switchable operating modes of the PMA

>&#8194;&#8195;While the CAN XL communication is possible using CAN transceivers compliant with ISO 11898-2, **higher data bit rates require CAN transceivers that can be switched into a dedicated operating mode for the XL data phase**. When that operating mode does not allow the dominant bus state to overwrite all other bus states, the error signalling is disabled by the node configuration.
>
>&#8194;&#8195;The PCS indicates the following CAN transceiver modes to the PMA sub-layer if the CAN transceiver mode switching is enabled:
>
>&#8194;&#8194;&#8195;- arbitration mode;
>
>&#8194;&#8194;&#8195;- data TX mode: active in the transmitter during ADH bit and XL data phase;
>
>&#8194;&#8194;&#8195;- data TX mode: active in the transmitter during ADH bit and XL data phase.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-CAN_transceiver_modes.png>

&#8194;&#8195;**FIG - CAN transceiver modes signalled to the PMA**

## 2.17 &#8194;Bus states and MAC sub-layer phases

>&#8194;&#8195;The MAC sub-layer distinguishes the following three phases,
>
>&#8194;&#8194;&#8195;- arbitration phase, in which the nominal bit time is used;
>
>&#8194;&#8194;&#8195;- FD data phase, in which the FD data bit time is used;
>
>&#8194;&#8194;&#8195;- XL data phase, in which the XL data bit time is used.
>
>&#8194;&#8195;ISO 11898-1 uses the terms dominant (0) and recessive (1) for the bit values of the MAC frame, independent of the CAN transceiver mode. FD data bit time and XL data bit time may be identical.
>
>&#8194;&#8195;If the CAN transceiver mode switching is enabled, the PMA sub-layer specified in ISO 11898-2 behaves in the following way. The CAN SIC XL transceiver of the transmitter sends the bus state level_1 instead of recessive and the bus state level_0 instead of dominant during the data TX mode. If the CAN transceiver mode switching is enabled, the CAN SIC XL transceiver of the receiver does not drive the bus during the data RX mode.
>
>&#8194;&#8195;The bus states level_1 and level_0 do not overwrite each other. If two nodes are driving concurrently level_1 and level_0, receiving nodes detect unpredictably either level_1 or level_0.

# 3 &#8194;CAN Data-Link-Layer Specification

## 3.1 &#8194;General

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Layered_architecture.png width="500px">

>&#8194;&#8195;... the LLC sub-layer (responsible for flow control, recovery management and time-stamping) ... 
>
>&#8194;&#8195;The DLL has a cross-layer function interface to the FCE. The MAC sub-layer operations are supervised by the FCE. **Fault confinement is a self-checking mechanism**, that distinguishes short disturbances from permanent failures.

## 3.2 &#8194;Time stamping

>&#8194;&#8195;The DLL may have a cross-layer function interface to a time-base for the time-stamping. When the time-stamping is not supported, time-base and time-stamps shall be treated as constant with the value 0.

&#8194;&#8195;Time stamping 指 CAN 支持时间触发模式，该模式下 CAN 节点内部定时器被激活，且被用于产生（发送和接收数据的）时间戳，存储在 CAN 寄存器内部。

&#8194;&#8195;内部定时器在每个 CAN 的位时间累加，在接收和发送的帧起始位的采样点位置被采样，并生成时间戳。

## 3.3 &#8194;DLL protocol

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Protocol_layer_interactions.png width="450px">

>&#8194;&#8195;**The DLL's SDU is called the LLC frame;** it also interfaces between the LLC sub-layer and the MAC sub-layer.
>
>&#8194;&#8195;**The DLL's PDU is called the MAC frame. This is the bit sequence seen on the CAN bus.** The MAC frame maybe
in CBFF, CEFF, FBFF, FEFF, or XLFF.

## 3.4 &#8194;LLC sub-layer

### 3.4.1 &#8194;Overview

>&#8194;&#8195;The LLC sub-layer shall provide the following functions: flow control, recovery management and time-stamping. # [3.4.6 Function of LLC](#346-functions-of-the-llc-sub-layer)
>
>&#8194;&#8195;The LLC sub-layer shall offer two types of connectionless transmission services to the LLC user. # [3.4.5.2](#3452-types-of-connectionless-mode-transmission-service)

### 3.4.2 &#8194;Notifications

&#8194;&#8195;The notifications sent between the LLC user and the LLC sub-layer are specified in following:

* &#8194;Notification sent from LLC user to LLC sub-layer
  
| Notification | Description |
| --- | --- |
| Reset_Request | Request to set the node into an initial state |

* &#8194;Notification sent from LLC sub-layer to LLC user
  
| Notification | Description |
| --- | --- |
| Reset_Response | Response to the Reset_Request |
| Node_Status | Indicates the current status of the node, i.e.it signals whether or not the node is in the bus-off state. |

### 3.4.3 &#8194;Structure of LLC frame

| Field | Size | Description |
| ---- | ---- | ---- |
| **ID** | (11+18) bit | Priority identifier:ID (28) to ID (18) are used for all frames with 11 - bit identifier format (CBFF,FBFF,XLFF) while ID (28) to ID (0) are used for all frames with 29 - bit. identifier format (CEFF, FEFF). |
| **Format** | 3 bit | The frame format is coded by the three bits IDE, FDF, and XLF <br /> - if 000, the MAC frame format is CBFF; <br /> - if 100, the MAC frame format is CEFF; <br /> - if 110, the MAC frame format is FEFF;<br /> - if 011, the MAC frame format is XLFF. |
| FTYP | 1 bit | **In CBFF and CEFF, the FTYP bit corresponds to the MAC frame's RTR bit**, this means that FTYP distinguishes between the frame types RF (FTYP = 1p) and DF ( FTYP = 0p); <br /> In FBFF and FEFF, the FTYP bit is ignored for transmission but corresponds to the MAC frame's RRS bit for reception; <br /> In XLFF, the FTYP bit corresponds to the MAC frame's RRS bit. |
| BRS | 1 bit | Bit rate switch: only used in FBFF and FEFF frames. |
| ESI | 1 bit | Error state indicator: only used in FBFF and FEFF frames. |
| SDT | 1 bit | SDU type: describes the structure of the frame's data field content, only used in XLFF frames. |
| SEC | 1 bit | Simple/extended content: flags if the data field contains simple or extended content. This is only used in XLFF frames. |
| **DLC** | (7+4) bit | Data length code: 7 MSB only used in XLFF frames. For XLFF frames the numbers 0 to 2047 code 1 to 2048 data bytes. **For DFs of all other formats the 4 LSB encode the number or data bytes.** |
| VCID | 1 bit | Virtual CAN channel ID: only used in XLFF frames. |
| AF | 4 bit | Acceptance field: only used in XLFF frames. |
| **LLC Data** | 0 to 2048 byte | Payload of the LLC frame. |

### 3.4.4 &#8194;Limited LLC frames

>* &#8194;A subset of the complete range of **identifiers** and **DLCs** may be implemented.

&#8194;&#8195;若 LLC 子层限制了 ID 范围，例如只支持 11 bit CAN-ID，则意味着只有携带受限 CAN-ID 的 LLC DFs 或 RFs（IDE 置 0）可被传输 / 接收.

&#8194;&#8195;若 LLC 子层限制了 DLC 范围，例如支持的 DLC 小于 CAN 帧规定的最大值，则在 LLC DF 中超出限制的数据字节应被填充（padding）；CAN 节点也可能会配置对超出 DLC 规定范围的帧不进行传输.

>* &#8194;The padding of the data field of received DFs does not need to be implemented in the LLC layer.

### 3.4.5 &#8194;Services of LLC sub-layer

#### 3.4.5.1 &#8194;Service access points

>&#8194;&#8195;In CAN nodes, the LLC's service access point is the LLC storage unit, e.g. a memory buffer for the transmission or for the reception of a DF or RF.

#### 3.4.5.2 &#8194;Types of connectionless-mode transmission service

>&#8194;&#8195;The LLC sub-layer shall offer two types of connectionless-mode transmission service
>
>&#8194;&#8194;&#8195;1. Unacknowledged data transfer service: this service provides means by which LLC users exchange LSDU without establishing a data link connection.
>
>&#8194;&#8194;&#8195;2. Unacknowledged remote data request service: this service provides means used by an LLC user to request a remote node for an LSDU transmission without establishing a data link connection.

&#8194;&#8195;远端节点有两种方式来为数据请求提供服务： 请求数据可能已由远程节点准备好传输，即此时数据位于节点缓存区内，收到 RF 时进行传输；请求数据由远程节点在接收到 RF 之后传输。

>&#8194;&#8195;According to the two different LLC services,seven types of frames may be used for the communication between transmitting node and receiving nodes:
>
>&#8194;&#8194;&#8195;- LLC DF in CBFF
>
>&#8194;&#8194;&#8195;- LLC DF in CEFF
>
>&#8194;&#8194;&#8195;- LLC DF in FBFF
>
>&#8194;&#8194;&#8195;- LLC DF in FEFF
>
>&#8194;&#8194;&#8195;- LLC RF in CBFF
>
>&#8194;&#8194;&#8195;- LLC RF in CEFF
>
>&#8194;&#8194;&#8195;- LLC DF in XLFF

#### 3.4.5.3 &#8194;Service specification

&#8194;&#8195;**服务是各层向其上层提供的一组原语**，确定了其能为上一层提供的功能，以定义两层之间的接口。

&#8194;&#8195;服务原语格式如下：

```
      service.type(
          [parameter1,]
      )
```

>&#8194;&#8195;**service** indicates the name of the service, e.g. L_Data for data transfer;
>
>&#8194;&#8195;**type** indicates the type of the service primitives;
>
>&#8194;&#8195;**[parameter1,]** is the list of values passed to the service primitives. (The list can be empty.)

*  &#8194;**LLC Unacknowledged data transfer service**

&#8194;&#8195;&#8195;The same as Unacknowledged remote data transfer service. (以下 L_Data 改为 L_Remote)

| Services | Description |
| --- | --- |
| L_Data.Request | Request for data transfer |
| L_Data.AbortRequest | Request abortion of data transfer |
| L_Data.Confirm | Confirmation of data transfer request |
| L_Data.Indication | Indication of data transfer reception |

*  &#8194;**LLC service parameters**

| Parameter | Description |
| --- | --- |
| Frame | LLC frame |
| Transfer_Status | Confirmation: ongoing, lost arbitration, transmitted, aborted, disturbed |
| Timestamp | Time value captured on trigger from MAC sub-layer |
| Handle | Identifies LLC storage unit used for transaction |

##### 3.4.5.3.1 &#8194;L_Data.Request

>&#8194;&#8195;The L_Data.Request service shall be passed from the LLC user to the LLC sub-layer to request that an LLC frame is sent to one or more remote LLC entities.

```
   L_Data.Request(
          Frame
          Handle
          )
```
>&#8194;&#8195;The LLC storage unit to be used for the transmission is identified by the handle.
>
>&#8194;&#8195;Receipt of this service shall cause the LLC sub-layer to initiate the transfer of an LLC frame by use of the data transfer service provided by the MAC sub-layer. Any L_Data.Request shall be processed not later than the second SOF after the request when there are no EFs presentduring this time.

##### 3.4.5.3.2 &#8194;L_Data.AbortRequest

>&#8194;&#8195;The L_Data.AbortRequest service shall be passed from the LLC user to the LLC sub-layer to abort a previous request of an LLC frame transmission.

```
   L_Data.AbortRequest(
          Handle
          )
```

>&#8194;&#8195;The LLC storage unit for which the transmission shall be aborted is identified by the handle.
>
>&#8194;&#8195;The LLC sub-layer cannot abort transmissions that are already submitted to the MAC sub-layer (due to priority scheduling of the requested LLC storage unit indicated by the handle).
>
>&#8194;&#8195;Any L_Data.AbortRequest shall be processed prior to the second SOF after the request when there are no EFs present during this time.
>
>&#8194;&#8195;Any L_Data.AbortRequest shall be processed prior to the third SOF after the request when there are EFs present during this time.

>* &#8194;Pending transmissions, which are already passed to the MAC sub-layer, shall only be aborted if:
>
>&#8194;&#8194;&#8195;- an error in the MAC sub-layer during transmission occurs, or
>
>&#8194;&#8194;&#8195;- arbitration was lost in the MAC sub-layer, which causes the LLC frame to wait for another transmission attempt.
>
>&#8194;&#8195;This means that an abortion request shall be kept pending in the LLC layer until either one of the above situations occur, or until the transmission was completed.

##### 3.4.5.3.3 &#8194;L_Data.Confirm

>&#8194;&#8195;The L_Data.Confirm service shall be passed from the local LLC sub-layer to the LLC user to convey the results of the previous L_Data.Request service.

```
   L_Data.Confirm(
          Transfer_Status
          Timestamp
          Handle
          )
```

>&#8194;&#8195;The time-stamp is a 64-bit value, captured at one time reference point synchronized to MAC frame transmission. The time-stamp is valid when the Transfer_Status is transmitted. Otherwise,the time-stamp value is undefined.

##### 3.4.5.3.4 &#8194;L_Data.Indication

>&#8194;&#8195;The L_Data.Indication service shall be passed from the LLC sub-layer to the LLC user to indicate the arrival of the data of an LLC frame after the reception of a MAC frame.

```
   L_Data.Indication(
          Frame
          Timestamp
          )
```

### 3.4.6 &#8194;Functions of the LLC sub-layer

>&#8194;&#8195;The LLC sub-layer provides the following functions:
>
>&#8194;&#8194;&#8195;- Flow control;
>
>&#8194;&#8194;&#8195;- Frame acceptance filtering;
>
>&#8194;&#8194;&#8195;- Overload notification;
>
>&#8194;&#8194;&#8195;- Recovery management;
>
>&#8194;&#8194;&#8195;- Time-stamping.

#### 3.4.6.1 &#8194;Flow control on re-arbitration

>&#8194;&#8195;The transmission of frames losing bus arbitration shall be restarted by the LLC entity unless the transmission of that frame is aborted by the LLC user. The restart of the transmission after the loss of arbitration is called a re-arbitration. 

#### 3.4.6.2 &#8194;Flow control on retransmission

>&#8194;&#8195;The restart of the unsuccessful transmission, except after the loss of arbitration, is called a retransmission. The retransmission of frames that are not aborted by the LLC user shall be attempted for the configured specific number of times. Retransmission attempts shall be counted in the retransmission counter. 
>
>&#8194;&#8195;The node's retransmission counter shall be reset to zero when a transmission is successful or when the LLC user requests a new transmission. 
>
>&#8194;&#8195;**Nodes that do not support the XL frame format are not required to implement the retransmission counter, but they shall support unlimited retransmissions.**

#### 3.4.6.3 &#8194;Frame acceptance filtering

>&#8194;&#8195;Each receiver should decide by frame acceptance filtering whether the frame is relevant or not.

&#8194;&#8195;CAN-ID 不代表节点的地址，而是和报文的内容有关，所以节点根据 CAN-ID 决定是否需要接收该报文；

&#8194;&#8195;以 STM32 CAN 控制器为例，每个过滤器组由两个 32 位寄存器（CAN_FxR0 和 CAN_FxR1）组成，且根据所需位宽的不同，可配置成 16 位或 32 位模式。

&#8194;&#8195;过滤器模式可配置成掩码模式或列表模式（ FBMx = 0 为掩码模式， FBMx = 1为列表模式）

&#8194;&#8194;&#8195;**- 掩码模式（屏蔽位模式）：** 该模式下，标识符寄存器和掩码寄存器一起作用，指定接收报文 ID 的任何一位，按照“必须匹配”或“不用关心”处理，**通常用于匹配一组 CAN-ID**；

&#8194;&#8194;&#8194;&#8195;**示例：** 

```
     标识符寄存器： 11 0001 0110

     掩码寄存器： 11 0001 0111

     则计算结果为： 11 xxx1 x110
```

&#8194;&#8194;&#8194;&#8195;匹配以上结果的 CAN-ID 报文均可通过过滤器，其中，x 表示不关心匹配的是 0 还是 1。

&#8194;&#8194;&#8195;**- 列表模式：** 该模式下，掩码寄存器也被当做标识符寄存器使用，即通过两个标识符寄存器，接收报文 ID 的每一位都必须与过滤器标识符相同，**通常用于匹配某个 CAN-ID**；

&#8194;&#8194;&#8194;&#8195;**示例：** 

```
     标识符寄存器： 11 0001 0110

     标识符寄存器： 11 0001 0111

     则支持匹配的 CAN-ID 仅有以上两个： 11 0001 0110 & 11 0001 0111
```

&#8194;&#8195;对于下图四种应用模式，个人理解为：

&#8194;&#8194;&#8195;- 标识符寄存器与掩码寄存器间可视为串联模式，即对于第一与第三场景，过滤器至多支持的 CAN-ID 分别为一组和两组；

&#8194;&#8194;&#8195;- 标识符寄存器与标识符寄存器间可视为并联模式，即对于第二与第四场景，过滤器至多支持的 CAN-ID 分别为两个和四个；

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-STM32_filter.png width="640px">

* &#8194;从实际测试来看，通过模拟节点（发送方）在总线上对唯一 CAN 节点（接收方）发送任意 0x0 ~ 0x7FF CAN-ID 报文，并不会引发想象中由于 CAN-ID 被过滤，这一 CAN 帧未被任何节点接收，从而引发错误帧；

&#8194;&#8195;&#8195;个人看法：首先，过滤器位于 LLC 子层，但错误处理及接收操作都是由下层即 MAC 子层和物理层去完成的，但由于这一 CAN 帧本身没有任何问题的，所以接收方的 MAC 子层也并不会检测到任何错误从而发送错误帧，进而总线上表现出任意 CAN 帧都被接收，但推测 CAN-ID 会在 LLC 层过滤掉而不会往上传输（至应用层）；

* &#8194;对于网络管理，当 CAN 节点休眠时，只接收指定 CAN-ID 的唤醒报文（否则会出现错误帧），但从 Autosar 开发模块图示来看，网络管理似乎是独立模块而没有涉及到 CAN Filter 。

#### 3.4.6.4 &#8194;Overload notification

>&#8194;&#8195;The transmission of a OF shall be initiated by the LLC sub-layer if internal conditions of a receiver require delay of the next LLC DF or LLC RF. 
>
>&#8194;&#8195;If there are internal conditions of a CAN node that cause a OF to be initiated, these conditions shall be documented for that CAN node. **In this case, the CAN node shall not generate more than two OFs.**

#### 3.4.6.5 &#8194;Recovery management

>&#8194;&#8195;The LLC sub-layer's transmission service shall report the Transfer_Status of a requested transmission as Ongoing when the MAC has started that transmission.
>
>&#8194;&#8195;It shall report the Transfer_Status as Transmitted when that transmission is successfully completed.
>
>&#8194;&#8195;It shall report the Transfer_Status as Lost_Arbitration when that transmission loses the bus arbitration, until the frame is started again or aborted.
>
>&#8194;&#8195;It shall report the Transfer_Status as Disturbed when that transmission is disturbed by an error or is not acknowledged, until the frame is started again or aborted.
>
>&#8194;&#8195;It shall report the Transfer_Status as Aborted when that transmission is not successful and is not retransmitted because the frame is aborted, or its retransmission limit is reached.

#### 3.4.6.6 &#8194;Time stamping

>&#8194;&#8195;For the capturing of time stamps, the LLC may provide a cross-layer function interface to a time-base that is outside the DLL. The time-base and time-stamps shall have a length of 64 bit. When time-stamping is not supported, time-base and time-stamps shall be treated as constants with the value 0.
>
>&#8194;&#8195;The time-base shall be captured at time reference points signalled by the MAC sub-layer (see [4.5.3](#453-time-reference-points)); the captured values shall be reported as time-stamps by the services L_Data.Confirm and L_Data.Indication.
>
>&#8194;&#8195;It shall be configurable whether the time reference point at the SOF recognition or at the position when the frame gets valid shall be used for capturing.
>
>&#8194;&#8195;For the service L_Data.Confirm, a time-stamp shall be captured at the time reference point of the transmission of the MAC frame.
>
>&#8194;&#8195;For the service L_Data.Indication, a time-stamp shall be captured at the time reference point of the reception of the MAC frame.

## 3.5 &#8194;MAC sub-layer

### 3.5.1 &#8194;Functions and rules

>&#8194;&#8195;The MAC sub-layer services the interface to the LLC sub-layer and the PMA, and comprises the functions and rules related to:
>
>&#8194;&#8194;&#8195;- encapsulation / decapsulation of the transmit / receive data;
>
>&#8194;&#8194;&#8195;- error detection and signalling;
>
>&#8194;&#8194;&#8195;- management ofthe transmit / receive;

### 3.5.2 &#8194;Services of the MAC sub-layer

>&#8194;&#8195;The MAC sub-layer shall provide services to the local LLC for: 
>
>&#8194;&#8194;&#8195;- (MAC-)acknowledged transfer of LLC frames; 
>
>&#8194;&#8194;&#8195;- time reference points synchronized to MAC frame reception; 
>
>&#8194;&#8194;&#8195;- time reference points synchronized to MAC frame transmission; 
>
>&#8194;&#8194;&#8195;- (MAC-)acknowledged transfer of OFs.

### 3.5.3 &#8194;Time reference points

>&#8194;&#8195;Any DF or RF received or transmitted by the MAC sub-layer shall cause a notification to be sent from the MAC sub-layer to the LLC sub-layer to signal a time reference point for the capture of the time-base as a time-stamp.
>
>&#8194;&#8195;Time reference points shall be signalled both at the sample point ofthe SOF bit and at the sample point of the bit ofthe frame when that frame gets valid.

### 3.5.4 &#8194;Functional model of MAC sub-layer architecture

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-MAC_Function.png width="400px">

>&#8194;&#8195;The MAC sub-laver is divided into two independently operating parts, i.e.the transmit part and the receive part.
>
>&#8194;&#8195;Data transmission and reception between nodes in a network is performed and controlled by four different frame types:
>
>&#8194;&#8194;&#8195;- a DF that carries data from a transmitter to all receivers;
>
>&#8194;&#8194;&#8195;- a RF transmitted by a node for requesting transmission of the DF with the same identifier;
>
>&#8194;&#8194;&#8195;- an EF transmitted by any node (transmitteror receiver)in case a bus error is detected;
>
>&#8194;&#8194;&#8195;- an OF used for providing an extra delay between the preceding and succeeding DFs or RFs.
>
>&#8194;&#8195;DFs and RFs shall arbitrate for bus access and shall be separated from preceding frames by an inter-frame space.
>
>&#8194;&#8195;There are five different DFs in CAN:
>
>&#8194;&#8194;&#8195;- DF in CC base frame format;
>
>&#8194;&#8194;&#8195;- DF in CC extended frame format
>
>&#8194;&#8194;&#8195;- DF in FD base frame format
>
>&#8194;&#8194;&#8195;- DF in FD extended frame format
>
>&#8194;&#8194;&#8195;- DF in XL frame format.
>
>&#8194;&#8195;There are two different RFs in CAN:
>
>&#8194;&#8194;&#8195;- RF in CC base frame format
>
>&#8194;&#8194;&#8195;- RF in CC extended frame format.

#### 3.5.4.1 &#8194;MAC frame transmission

>&#8194;&#8195;Frame transmission shall fulfil the following requirements.
>
>&#8194;&#8195;**Transmit data encapsulation:**
>
>&#8194;&#8194;&#8195;- acceptance of LLC frames and interface control information;
>
>&#8194;&#8194;&#8195;- CRC sequence calculation including stuffbit count for FD frames and for XL frames;
>
>&#8194;&#8194;&#8195;- **construction of MAC frames in the selected format by adding(as needed) SOF, RRS bit, IDE bit, RTR bit, SRR bit, FDF bit, XLF bit, res XL bit, BRS bit, ESI bit, ADS, PCRC, FCRC, FCP, DAS, ACK, and EOF to the LLC frame.**
>
>&#8194;&#8195;**Transmit medium access management:**
>
>&#8194;&#8194;&#8195;- initiation of the transmission process after recognizing bus idle (compliance with inter-frame space);
>
>&#8194;&#8194;&#8195;- serialization of the MAC frame;
>
>&#8194;&#8194;&#8195;- insertion of stuff bits (bit stuffing);
>
>&#8194;&#8194;&#8195;- arbitration and passing into receive mode in case of loss of arbitration;
>
>&#8194;&#8194;&#8195;- error detection (monitoring, format check);
>
>&#8194;&#8194;&#8195;- ACK checking;
>
>&#8194;&#8194;&#8195;- recognition of an overload condition;
>
>&#8194;&#8194;&#8195;- **OF construction and initiation of transmission;**
>
>&#8194;&#8194;&#8195;- **EF construction and initiation of transmission;**
>
>&#8194;&#8194;&#8195;- presentation of a serial bit stream to the PMA for transmission;
>
>&#8194;&#8194;&#8195;- switching of the bit rate for FD frames and for XL frames;
>
>&#8194;&#8194;&#8195;- signalling when the switching ofthe PMA operating mode for XL frames can occur.

#### 3.5.4.2 &#8194;MAC frame reception

>&#8194;&#8195;Frame reception shall fulfil the following requirements.
>
>&#8194;&#8195;**Receive medium access management:**
>
>&#8194;&#8194;&#8195;- reception of a serial bit stream from the PMA;
>
>&#8194;&#8194;&#8195;- switching of the bit rate for FD frames and for XL frame;
>
>&#8194;&#8194;&#8195;- signal when the switching of the PMA operating mode for XL frames should occur;
>
>&#8194;&#8194;&#8195;- deserialization and recompiling of the frame structure;
>
>&#8194;&#8194;&#8195;- deletion of stuff bits (bit de-stuffing);
>
>&#8194;&#8194;&#8195;- error detection (CRC,stuff bit count check,format check,stuffrule check);
>
>&#8194;&#8194;&#8195;- transmission of ACK;
>
>&#8194;&#8194;&#8195;- recognition of an overload condition;
>
>&#8194;&#8194;&#8195;- **OF construction and initiation of transmission;**
>
>&#8194;&#8194;&#8195;- **EF construction and initiation of transmission.**
>
>&#8194;&#8195;**Receive data de-capsulation:**
>
>&#8194;&#8194;&#8195;- removing the MAC specific information from the received frame;
>
>&#8194;&#8194;&#8195;- presenting the LLC frame and interface control information to the LLC sub-layer.

### 3.5.5 &#8194;MAC frame intro

&#8194;&#8195;根据 [3.5.4](#354-functional-model-of-mac-sub-layer-architecture) 中描述以及其余补充部分，可推断，MAC Frame 就是所谓的 CAN Frame；

&#8194;&#8195;对于 EF 和 OF，按照以上 3.5.4 MAC 子层结构功能描述，EF 和 OF 的构建及收发位于 MAC 子层；个人看法，EF 和 OF，并不会在 MAC 和 LLC 子层间传输，但是“错误状态”和“过载状态”的信息应进行传递。

&#8194;&#8195;对于 DF 和 RF： 

>&#8194;&#8195;On transmission, an LLC frame shall be converted into a MAC DF or MAC RF. On reception, a MAC DF or MAC RF shall be converted into an LLC frame.
>
>&#8194;&#8195;MAC DFs and MAC RFs shall be composed of the following seven different bit fields: **SOF**; **arbitration field** (contains identifier and part of format control); **control field** (contains DLC and part of format control); **data field** (contains LLC data field); **CRC field**; **ACK field**; **EOF**.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-MAC_DF.png width="540px">

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-MAC_RF.png width="480px">

### 3.5.6 &#8194;Classical CAN Frame Specification

&#8194;&#8195;CAN Frame 类型主要包括以下：  

&#8194;&#8194;&#8195;1. **Data Frame 数据帧**: 携带从发送节点至接收节点的数据，包括**标准数据帧**及**扩展数据帧**两种形式； 

&#8194;&#8194;&#8195;2. **Remote Frame 远程帧**: 向其他节点请求发送具有同一 CAN-ID 的数据帧；  

&#8194;&#8194;&#8195;3. **Error Frame 错误帧**: 节点检测到错误后发送错误帧；  

&#8194;&#8194;&#8195;4. **Overload Frame 超载帧**: 节点检测到过载条件时发送，在先行及后续的 DF（或 RF）之间附加一段延时；  

&#8194;&#8195;以及： 

&#8194;&#8195;**IFS /Inter-frame Space 帧间空间**: 包含 **Intermission 帧间隔**，**Bus idle 总线空闲** 以及 **Suspend transmission 暂停传输**（针对被动错误节点）。

>&#8194;&#8195;The CC frames can be data frames or remote frames, with an 11-bit long identifier or with a 29-bit long identifier. They can contain from zero to eight bytes in the data field.

#### 3.5.6.1 &#8194;Data Frame

##### 3.5.6.1.1 &#8194;Data Frame Standard Format

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Standard_Format_Data_Frame.png>

###### 3.5.6.1.1.1 &#8194;Start Of Frame

&#8194;&#8195;- **SOF / Start of Frame / 帧起始**：1 bit，SOF 是数据帧（或远程帧）传输的起始位。发送方会发送一个显性电平作为 SOF ，由于总线空闲时总线会保持隐性电平，因此 SOF 发出后会产生一个跳变沿（从 1 到 0 ）用于整个 CAN 网络的时间同步。为了在帧传输期间保持与发送方的同步，接收方会对所有隐性电平到显性电平的跳变沿进行是否与发送方保持同步的判断（硬同步），如果出现偏差，接收方将按照相关相位误差量重新进行同步（重同步）；

>&#8194;&#8195;SOF shall mark the beginning of DFs and RFs. It shall be dominant. A node shall send an SOF only when the bus is idle.
>
>&#8194;&#8195;A node sampling a dominant bit during its suspend transmission time or at the third bit of intermission shall accept it as SOF.
>
>&#8194;&#8195;All nodes shall synchronize to the leading edge caused by SOF of the first node.

###### 3.5.6.1.1.2 &#8194;Arbitration Field

&#8194;&#8195;- **Arbitration**

>&#8194;&#8195;**Arbitration between CC frames shall start with the ID-28 bit and shall end with the RTR bit.**
>
>&#8194;&#8195;When a node transmits a recessive bus state at one of these bits and samples a dominant bus state, it shall lose arbitration and it shall become receiver of that frame. 
>
>&#8194;&#8195;The recessive values of SRR and IDE bit ensure that collisions between a frame in CBFF or FBFF and a frame in CEFF or FEFF, with both frames having the same base identifier, are resolved such that the frame in CBFF or FBFF prevails over the frame in CEFF or FEFF. 
>
>&#8194;&#8195;The recessive value of the RTR bit in RFs ensure that collisions between a DF and an RF having the same identifier and format are resolved such that the DF prevails over the RF.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-CC_Arbitration.png width="600px">

&#8194;&#8195;- **ID / Identifier / 标识符**： 11 bit （0x0 up to 0x7FF hexadecimal），用于区分数据帧的优先级，并根据通信矩阵中定义的收发关系为节点中的接收过滤器提供过滤依据；

&#8194;&#8195;- **RTR / Remote Transmission Request / 远程传输请求位**： 1 bit，发送方将其用于通知接收方帧的类型（数据帧或远程帧）。RTR 位为显性（逻辑 0）表示数据帧，隐性（逻辑 1）则表示远程帧；

###### 3.5.6.1.1.3 &#8194;Control Field

&#8194;&#8195;- **IDE / Identifier Extension bit / 标识符扩展位**： 1 bit，IDE 位用于区分标准格式和扩展格式，显性为标准 ID 有 11 位，隐性为扩展 ID 有 29 位；

&#8194;&#8195;- **r (r0)**: 1bit，作为保留位， Classical CAN 中未定义其内容，在指定保留位的功能之前，一般置为显性位；

>&#8194;&#8194;&#8194;&#8195;**r (r0): a CAN FD tolerant CAN node shall detect a protocol exception event when this bit is received recessive.**

&#8194;&#8195;- **DLC / Data Length Code / 数据长度代码**： 4 bit，DLC 表示数据场中的有效负载的字节数，一个 Classical CAN 数据帧最多可以传输八个字节；

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-DLC_Coding.png width="400px">

###### 3.5.6.1.1.4 &#8194;Date Field

&#8194;&#8195;- **Data Field / 数据场**： 64 bit，数据内容，一帧可发送 0 ~ 8 个字节的数据，MSB先发，其中：   

&#8194;&#8195;&#8195;DLC 为 0 ~ 8 ： 对应数据场的实际字节数；  

&#8194;&#8195;&#8195;DLC 为 9 ~ 15 ： 8 字节数据；

>&#8194;&#8195;There is no data field in DFs with DLC = 0 and in all RFs. In that case, the control field is immediately followed by the CRC field.

###### 3.5.6.1.1.5 &#8194;CRC Field

&#8194;&#8195;- **CRC sequence/ cyclic redundancy check sequence/ 循环冗余校验码**： 15 bit，发送方计算 SOF ~ Data Field 的 CRC 校验值（CRC_TX）；接收方使用相同算法进行 CRC_RX 计算，并完成 CRC_RX 与 CRC_TX 的对比，并确认是否一致；

&#8194;&#8195;- **DEL / CRC delimiter / CRC 界定符**： 1 bit，隐性位表示；

>&#8194;&#8194;&#8195;- CRC-15, used for CC frames;
>
>&#8194;&#8194;&#8195;- CRC-17, used for FD frames with a date field up to 16 byte long;
>
>&#8194;&#8194;&#8195;- CRC-21, used for FD frames with a date field longer than 16 byte;
>
>&#8194;&#8194;&#8195;- CRC-13, used for the arbitration and control fields of XL frames;
>
>&#8194;&#8194;&#8195;- CRC-32, used for the whole XL frame.

>&#8194;&#8195;**The relevant bit stream for CRC calculation is the bit stream consisting of SOF, arbitration field, control field, and (if present) data field.**
>
>&#8194;&#8195;**In CC frames, stuff bits shall not be included in the relevant bit stream for CRC calculation.**

###### 3.5.6.1.1.6 &#8194;ACK field

&#8194;&#8195;- **ACK slot / Acknowledgement slot**： 1 bit，所有匹配 CRC sequence （CRC Pass） 的接收节点都应在 ACK slot 内通过用显性位覆盖发送方的隐性位来发送 ACK **（根据计算后的结果，每个接收节点都会给出应答，与节点是否会过滤该报文无关）**，即发送方的 ACK 位实际由接收方的 ACK 返回值决定，其中：  

&#8194;&#8195;&#8195;ACK on bus = 0 -> message transmitted correctly reception by at least one without error;  

&#8194;&#8195;&#8195;ACK on bus = 1 -> transmission error occurred or no receiver at all;

>&#8194;&#8195;All nodes that receive the matching FCRC sequence shall send an ACK within the ACK slot by overwriting the recessive bit of the transmitter with a dominant bit (they send ACK).

&#8194;&#8195;- **DEL / ACK delimiter / ACK 界定符**： 1 bit，隐性位表示；

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Positive_ACK.png>

###### 3.5.6.1.1.7 &#8194;End Of Frame

&#8194;&#8195;- **EOF**： EOF 由 7 个连续隐性位组成，在此之后，报文传输结束；

##### 3.5.6.1.2 &#8194;Data Frame Exteded Format

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Data_Frame.png>

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Extended_Format_Data_Frame.png width="720px">

&#8194;&#8195;扩展数据帧与标准数据帧的主要区别在于：  

&#8194;&#8194;&#8195;1. 扩展数据帧支持 29（11 + 18） bit 的 CAN-ID，即 0x00000000 up to 0x1FFFFFFF，以此扩展更多的 CAN 节点；  

&#8194;&#8194;&#8195;2. 仲裁场中包含一个 SRR (Substitute Remote Request / 替代远程请求) 位，以隐性位发送；  

&#8194;&#8194;&#8195;3. IDE 位为隐性；  

&#8194;&#8194;&#8195;4. 支持两个保留位 r1 和 r0，一般以显性位发送；

>&#8194;&#8194;&#8194;&#8195;**r1: a CAN FD tolerant CAN node shall detect a protocol exception event when this bit is received recessive.**
>
>&#8194;&#8194;&#8194;&#8195;**r0: receivers shall accept it with recessive and with dominant state.**

&#8194;&#8195;**Q - 关于为何设置 SRR 位的个人想法如下：**  

&#8194;&#8195;在前 11 bit CAN-ID 完全一致的情况下，对比随后 2 bit 状态 —— 标准数据帧/远程帧为 RTR + IDE & 扩展数据帧/远程帧为 SRR + IDE：  

&#8194;&#8194;&#8195; - 标准数据帧为： 0 + 0;  

&#8194;&#8194;&#8195; - 标准远程帧为： 1 + 0;  

&#8194;&#8194;&#8195; - 扩展数据帧为： 1 + 1;（若扩展帧也采用 RTR + IDE 的形式则为 0 + 1）  

&#8194;&#8194;&#8195; - 扩展远程帧为： 1 + 1;  

&#8194;&#8195;从上述结论看，SRR 位确保了标准远程帧的优先级高于扩展数据帧。


* &#8194;用于卡车及客车的 SAE 1939 协议通常是 18xx xxxx 的 CAN-ID;

> &#8194;&#8195;The SRR bit shall be transmitted recessive, but receivers shall accept recessive and dominant SRR bits. **This means that the reception of dominant SRR bit is not regarded as form error.**

#### 3.5.6.2 &#8194;Remote Frame

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Remote_Frame.png)

&#8194;&#8195;通常，数据传输由数据源节点（e.g. 传感器发出数据帧）自主完成。但也可能存在目标节点向源节点请求发送数据的情况。为此，目标节点需发送一个远程帧，其中的 CAN-ID 应与所需数据帧的标识符相匹配。随后，相应的数据源节点会发送一个数据帧以响应远程帧请求
；  
&#8194;&#8195;远程帧与数据帧的区别在于其不携带 Date Field，且 RTR 位为隐性状态，其他内容则完全一致；  

&#8194;&#8195;远程帧同样分为**标准远程帧**和**扩展远程帧**，格式可参考数据帧部分；

#### 3.5.6.3 &#8194;Error Frame

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_Active_Error_Frame.png width="520px">

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_Passive_Error_Frame.png width="520px">

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Active_Node.png width="550px">

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Passtive_Node.png width="550px">

&#8194;&#8195;**Error Frame = Error Flag (Active / Passtive) + Error Delimiter**  

&#8194;&#8195;**Active Error Flag = 连续 6 个显性位；**  

&#8194;&#8195;**Passtive Error Flag = 连续 6 个隐性位；**  

&#8194;&#8195;**Error Delimiter = 连续 8 个隐性位；**

>&#8194;&#8195;The EF consists of two different fields. The first field contains a **superposition of error flags** contributed from different nodes. The second field is the error delimiter.

>&#8194;&#8195;There are two forms of error flag used: 
>
>&#8194;&#8194;&#8195;- the active error flag shall consist of six consecutive dominant bits;
>
>&#8194;&#8194;&#8195;- the passive error flag shall consist of six consecutive recessive bits unless it is overwritten by dominant bits from other nodes. 

&#8194;&#8195;**主动错误详述**

>&#8194;&#8195;An error-active node detecting an error condition shall signal this by sending an active error flag. 
>
>&#8194;&#8195;**The form of the error flag violates the rule of bit stuffing or destroys the bit field requiring fixed form. Consequently, all other nodes shall detect an error condition too and shall start sending an error flag.**
>
>&#8194;&#8195;So, the sequence of dominant bits, which may be monitored on the bus, results from a superposition of different error flags sent by individual nodes. The total length of this sequence may vary between a minimum of 6 bit and a maximum of 12 bit.

&#8194;&#8195;**被动错误详述**

>&#8194;&#8195;Passive error flags initiated by a transmitter shall cause error(s) (with two exceptions) at the receiver(s) when they start in a frame field encoded by the method of bit stuffing, **because then they lead to stuff errors detected by the receivers.** 
>
>&#8194;&#8195;The first exception is a passive error flag that starts during arbitration and another node continue stransmitting,
>
>&#8194;&#8195;and the second exception is a passive error flag that starts less than 6 bit before the end of the Frame-CRC sequence and the last bits of the CRC sequence happen to be all recessive.
>
>&#8194;&#8195;Passive error flags initiated by receivers shall not be able to prevail over any activity on the bus.

&#8194;&#8195;**Error Delimiter**

>&#8194;&#8195;The error delimiter shall consist of eight recessive bits. After sending an error flag, each node shall monitor the bus until it detects a recessive bit. At this point in time, every node shall finish sending its error flag and all nodes shall start sending seven more recessive bits simultaneously, to complete the 8-bit error delimiter.

&#8194;&#8195;个人看法：以上说明，针对的是同一时间段发送错误帧的节点，即假设 A 节点检测到位错误发送主动错误帧，导致 B 和 C 节点检测到填充错误而发送主动错误帧，则 A 节点会完成 Error flag + Error Delimiter 的连续过程，B 和 C 需要按上述过程完成错误帧的发送，本质是因为 A 与 B / C 发送时段已经不同；关于上述过程的可能解释：发送连续 6 位显（隐）性位会导致时钟不同步，检测隐性位相当于对齐时钟，后面再一起发送，确保同时完成错误界定符的发送。

#### 3.5.6.4 &#8194;Overload Frame

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_Overload_Frame.png width="520px">

&#8194;&#8195;**Overload Frame = Overload Flag("000000") + Overload Delimiter**  

&#8194;&#8195;即过载帧的构成与主动错误帧完全一致；

>&#8194;&#8195;Following types of OF shall have the same format: 
>
>&#8194;&#8194;&#8195;- LLC requested OF: This OF is requested by the LLC sub-layer to indicate an internal overload situation;
>
>&#8194;&#8194;&#8195;- Reactive OF: The transmission of the reactive OF shall be initiated by the MAC sub-layer upon certain error conditions.
>
>&#8194;&#8195;The overload delimiter shall consist of eight recessive bits. After sending an overload flag, each node shall monitor the bus until it detects a recessive bit. At this point in time, every node shall finish sending its overload flag and all nodes shall start sending seven more recessive bits simultaneously, to complete the 8-bit overload delimiter.

&#8194;&#8195;大部分高层协议并不使用过载帧，其实际出现场景也几乎没有。

##### 3.5.6.5 &#8194;Inter-frame space specification

##### 3.5.6.5.1 &#8194;Separation of frames

>&#8194;&#8195;**DFs and RFs shall be separated from preceding frames, whatever frame type the preceding frames are (DF, RF, EF, OF), by a time period called inter-frame space.**
>
>&#8194;&#8195;**In contrast to this, EFs and OFs shall not be preceded by inter-frame space,and multiple OFs shall not be separated by inter-frame space.**
>
>&#8194;&#8195;Inter-frame space shall contain the bit field intermission and bus idle time. For error-passive nodes, which have been transmitter of the previous frame, inter-frame space shall also contain the node's suspend transmission time.

&#8194;&#8195;数据帧（或远程帧）通过 IFS 可以将本帧与先行帧（数据帧、远程帧、错误帧、过载帧）分隔开来；  

&#8194;&#8195;错误帧和过载帧前不能插入 IFS；  

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Inter_frame_space_for_nodes.png width="540px">

&#8194;&#8195;**FIG - Inter-frame space for nodes, which are not error-passive or are receivers of previous DF or RF**

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Inter_frame_space_for_error_passive_nodes.png width="550px">

&#8194;&#8195;**FIG - Inter-frame space for error-passive nodes, which are transmitters of previous DF or RF**

##### 3.5.6.5.2 &#8194;Intermission

![image](https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-ITM_Frame.png)

>&#8194;&#8195;The intermission field shall consist of three recessive bits.
>
>&#8194;&#8195;During intermission, a node shall not start transmission of DFs or RFs.
>
>&#8194;&#8195;**An OF may be transmitted.**
>
>&#8194;&#8195;**The detection of a dominant bit at the third bit ofintermission shall be interpreted as SOF.**

&#8194;&#8195;帧间隔过后，如果无节点发送帧，则总线进入空闲；由上图可知，实际场景下，**当检测到连续 11 个隐性位后，判定总线进入空闲状态**；（个人看法： 可能这也是为什么错误界定符以及过载界定符设定为连续 8 个隐性位原因，其加上 3 位隐性，正好为连续 11 位隐性）

##### 3.5.6.5.3 &#8194;Bus idle

>&#8194;&#8195;When the bus is idle, any node may access the bus for transmission.
>
>&#8194;&#8195;The period of bus idle can be of arbitrary length.
>
>&#8194;&#8195;The bus shall be recognized to be idle by receivers and by error active transmitters when
>
>&#8194;&#8194;&#8195;- the third bit of intermission is seen recessive;
>
>&#8194;&#8194;&#8195;- by error passive transmitters when the eighth bit of suspend transmission time is seen recessive；
>
>&#8194;&#8194;&#8195;- or when the bus integrating state is left.

#### 3.5.6.5.4 &#8194;Suspend transmission

>&#8194;&#8195;**An error-passive node, which has been transmitter of the previous frame, shall suspend the start of further frame transmissions for 8 bit times following intermission.** If another node starts a transmission during that suspend transmission time, the node shall become a receiver of this DF or RF frame.

&#8194;&#8195;即帧间隔过后，如果被动错误节点要发送帧，则先发送 8 个隐性电平的传输延迟，再发送帧（保证主动错误节点优先发送，避免被动错误节点因硬件故障干扰整个网络）。

#### 3.5.6.5.5 &#8194;Bus re-integration

>&#8194;&#8195;CAN nodes shall start the bus re-integration after starting the protocol operation, during bus-off recovery, or (for nodes that are FD tolerant, FD enabled, or XL enabled) after detecting a protocol exception event.
>
>&#8194;&#8195;CAN nodes that are not in bus-off state shall finish the bus re-integration when the idle condition (detection of a consecutive sequence of 11 sampled recessive bits) is detected.
>
>&#8194;&#8195;There shall be a bit counter that is reset when the bus re-integration state is started or when the CAN bus is detected dominant at the sample point.  The bit counter shall be incremented when the CAN bus is detected recessive at the sample point.  The idle condition shall be detected when this bit counter reaches the value 11.  For the detection of the bus-off recovery condition (see xxx), there shall be a second counter that is incremented once each time the idle condition is detected.
>
>&#8194;&#8195;Nodes that are in bus-off state shall finish the bus re-integration when the bus-off recovery condition is met, and the idle condition is detected. 
>
>&#8194;&#8195;For nodes that are FD tolerant, FD enabled, or XL enabled, there shall be a third reset condition for the bit counter. It shall be reset when detecting an edge that causes synchronization. When synchronization occurs, the counting of the sequence of 11 consecutive recessive bits shall be restarted.
>
>&#8194;&#8195;For an optional edge filtering see xxx.
>
>&#8194;&#8195;When an FD tolerant, FD enabled, or XL enabled node is re-integrating, it reacts on dominant pulses that are shorter than a nominal bit time by restarting its bit counter for idle detection to ensure the shorter bits in the data phase of an FD frame or an XL frame are not mistakenly missed when waiting for an idle condition, regardless of their phase relationship.

### 3.5.7 &#8194;CAN_FD Frame Specification

#### 3.5.7.1 &#8194;General

&#8194;&#8195; CAN FD Frame 与 Classical CAN Frame 的主要差异体现在 DF 上， 且 CAN FD 无 RF， EF、OF、IFS 部分无差异。

* &#8194; Classical CAN 与 CAN FD 均采用两种类型的数据帧格式：具有11位标识符的标准帧和具有29位标识符的扩展帧；这可确保对 CAN FD 进行部分调整后即可使用 CANopen 和 SAE J1939 等基于 CAN 的高层协议。

* &#8194; CAN FD 没有为远程帧定义单独的格式，远程帧没有数据场，因此提高传输速率没有作用。但是，CAN FD 协议允许 Classical CAN 远程帧请求 CAN FD 帧。

* &#8194; CAN FD 控制器可以发送和接收 Classical CAN 帧以及 CAN FD 帧，但 Classical CAN 控制器（Not tolerant CAN FD）接收到 CAN FD 帧时将始终使用错误帧进行响应。

>&#8194;&#8195; The FD frames are data frames in two formats, FBFF with an 11-bit long identifier and FEFF with a 29-bit long identifier. They can contain from zero to 64 data bytes. There are no remote FD frames.

#### 3.5.7.2 &#8194;CAN FD Frame - FBFF

##### 3.5.7.2.1 &#8194;Same with Classical CAN

&#8194;&#8195;帧起始（SOF）、标识符和标识符扩展位（IDE）保持不变。此外，CAN FD 帧末尾的应答位（ACK）、相应的界定符（DEL）、帧结束（EOF）以及帧间间隔场（ITM）仍与 CC 相同。

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_FD-FBFF.png>

##### 3.5.7.2.2 &#8194;Arbitration Field

&#8194;&#8195;- **Arbitration**

>&#8194;&#8195;**Arbitration between FD frames shall start with the ID-28 bit and shall end with the FDF bit in the control field.** When a node transmits a recessive bus state at one of these bits and samples a dominant bus state, it shall lose arbitration and it shall become receiver of that frame.
>
>&#8194;&#8195;The recessive value of FDF bit in FD frames and the dominant value of the reserved bits in CC frames ensure that collisions between a CC frame and an FD frame, with both frames having the same identifier, are resolved such that the CC frame prevails over the FD frame.
>
>&#8194;&#8195;Nodes that do not support the XL frame format, that sample a dominant bus state when transmitting a recessive FDF bit may treat this as a bit error instead of losing arbitration.

&#8194;&#8195;- **RRS / Remote Request Substitution / 远程请求替代位**：1 bit 显性位，由于没有用于 CAN FD 的远程帧，因此 RTR 位不是必需的，所以被始终呈显性的 RRS 所取代。

>&#8194;&#8195;The RRS bit shall be transmitted dominant, but receivers shall accept recessive and dominant RRS bits.
>
>&#8194;&#8195;NOTE: This means that the reception of recessive RRS bit is not regarded as form error.

##### 3.5.7.2.3 &#8194;Control Field

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_FD-Switch_from_CAN_to_CAN_FD.png>

&#8194;&#8195;- IDE / Identifier Extension bit / 标识符扩展位： 1 bit，IDE 位用于区分标准格式和扩展格式，显性为标准 ID 有 11 位，隐性为扩展 ID 有 29 位；（和 Classical CAN 一致）

&#8194;&#8195;- **FDF / FD Format**：1 bit 隐性位，CC 的保留位成为 Classical CAN 和 CAN FD 的区别标识 —— 如果是显性值 0，则表示 CC；如果是隐性值 1，则表示 CAN FD。

&#8194;&#8195;- **r / reserved bit**：1 bit 显性位，CAN FD 保留位（后续成为了 CAN FD 和 CAN XL 的区别标识）。

>&#8194;&#8195;In FD frames, the FDF bit shall be followed by the dominant res bit. This bit distinguishes between FD frames and the XL frame. When an FD enabled receiver detects the res bit to be recessive instead of the expected  dominant it shall, when protocol exception handling is enabled, detect a protocol exception event; when  protocol exception handling is disabled, it shall treat this as a form error.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_FD-FDFF_Bit_Rate_Switch.png>

&#8194;&#8195;- **BRS / Bit Rate Switch / 位速率切换**：当该位为 0 时，表示 CAN FD 报文保持恒定速率传输（即此时，上图中，波特率 2 等同于波特率 1，不会加速传输），当该位为 1 时，数据段的传输速率将切换至高速率模式；

&#8194;&#8195;对于一条总线上的所有CAN FD控制器，必须统一配置这两个波特率（即上图中的波特率 1 和 2）。

>&#8194;&#8195;It is not required for the BRS bit to be the same in all FD frames in a single network.

&#8194;&#8195;- **ESI / Error State Indicator / 错误状态指示位**：如果该位为显性 0，则表明 ECU 处于主动错误状态；如果该位为隐性 1，则表明 ECU 处于被动错误状态；该位旨在以更加透明的方式跟踪错误，并简化网络管理，网络节点的主动错误和被动错误状态会在整个网络上传播。

&#8194;&#8195;- **DLC / Data Length Code / 数据长度代码**： 4 bit，DLC 表示数据场中的有效负载的字节数，as specified in # [3.5.6.1.1.3](#356113-control-field)

##### 3.5.7.2.4 &#8194;Data Field

&#8194;&#8195;0 ~ 64 个字节，用于节点之间传递有效数据。

>&#8194;&#8195;There is no data field in DFs with DLC=0.  In that case, the control field is immediately followed by the CRC field.

##### 3.5.7.2.5 &#8194;CRC Field

&#8194;&#8195;- **分析**：相较于 Classical CAN，CAN FD 帧中出现位错误的可能性有所增加。之所以如此，一方面是因为使用较高速的波特率的位时间更短，另一方面是因为数据场中的位数更多；解决此问题需要在 CAN FD 帧中实现更大的 CRC 计算，否则，接收方无法检测到错误的可能性就会增加。

&#8194;&#8195;- **SBC / Stuff (Bit) Count / 填充位计数**：4 bit，计算方式 —— 将 SOF ~ Data Field 的填充位个数进行模 8 运算，并以格雷编码形式（Gray - Coded），存放在前高 3 位中，最后一位（Parity Bit）用奇偶校验。

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_FD-SBC.png>

&#8194;&#8195;- **CRC sequence/ cyclic redundancy check sequence/ 循环冗余校验码**：数据场不超过16 个字节的 CAN FD 帧将由 17 位 CRC (CRC - 17 - 0x3685B) 保护；数据场超过 16 个字节时，对应为 21 位 CRC (CRC - 21 -  0x302899)；

&#8194;&#8194;&#8195;**与 Classical CAN 不同，CAN FD 会将 CRC Field 之前的动态填充位也计算在内**；根据原文描述，SBC 也应被计算在内，如下段所示。

>&#8194;&#8195;The relevant bit stream for the CRC calculation shall be the bit stream consisting of SOF, arbitration field, control field, and (if present) data field. **The stuff count and the dynamic stuff bits, but not the fixed stuff bits, shall be included in the relevant bit stream for CRC calculation of FD frames.**

&#8194;&#8195;- **CRC delimiter**：1 bit 隐性，涉及波特率切换，如下段所示。

>&#8194;&#8195;**NOTE：CAN nodes switch back from the data phase to the arbitration phase of FD frames when they reach the sample point of the (first bit of the) CRC delimiter.**
>
>&#8194;&#8195;The CRC delimiter shall follow the FCRC sequence. In FD frames, the CRC delimiter may consist of one or two recessive bits. A transmitter shall send one recessive bit as CRC delimiter, **but it shall accept two recessive bits before the edge from recessive to dominant that starts the acknowledge slot**. A receiver sends its acknowledge bit after the first CRC delimiter bit.

##### 3.5.7.2.6 &#8194;ACK Field

>&#8194;&#8195;- **ACK slot**
>
>&#8194;&#8194;&#8195;Nodes that receive the matching FCRC sequence and the matching stuff count shall send an ACK within the ACK slot by overwriting the recessive bit of the transmitter with a dominant bit (they send ACK). 
>
>&#8194;&#8194;&#8195;**In FD frames, all nodes shall accept an up to two bit long dominant phase of overlapping ACK slot bits as a valid ACK, to compensate for phase shifts between the receivers.**
>
>&#8194;&#8195;- **ACK delimiter**: The ACK delimiter, being the last bit of the ACK field, shall be a recessive bit.

&#8194;&#8195;**关于 CRC delimiter & ACK slot 的补充说明**：根据原文描述，CAN FD 中，对于接收节点，允许其利用最大两个位时间来识别 CRC delimiter 和 ACK slot 的有效性；个人认为可能是考虑到由高速波特率切换至低速波特率时，时钟切换会导致接收端相移以及总线传播延迟。

#### 3.5.7.3 &#8194;CAN FD Frame - FEFF

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_FD-FEFF.png>

### 3.5.8 &#8194;CAN_XL Frame Specification

#### 3.5.8.1 &#8194;General

&#8194;&#8195; CAN XL Frame 与 CAN FD Frame 及 Classical CAN Frame 的主要差异体现在 DF 上， 且 CAN XL 无 RF 和 Extended DF， EF、OF、IFS 部分无差异。

>&#8194;&#8195;XL frames are DFs in XLFF with an 11-bit bit priority ID. The data field has a length of one byte to 2048 byte. There is no RF specified.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-XLFF.png>

##### 3.5.8.2.2 &#8194;Arbitration filed

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-XLFF_Arbitration_filed.png>

&#8194;&#8195;- **Arbitration**

>&#8194;&#8195;**Arbitration between XL frames shall start with the ID28 bit and shall end with the XLF bit.** When a node transmits a recessive bus state at one of these bits and samples a dominant bus state, it shall lose arbitration and it shall become receiver of that frame.
>
>&#8194;&#8195;The recessive value of FDF and XLF bits in XL frames and the dominant value of the reserved bits in CC frames and FD frames ensure that collisions between a CC frame and an XL frame or between an FD frame and an XL frame, with both frames having the same identifier, are resolved such that the CC frame or the FD frame prevails over the XL frame.

&#8194;&#8195;- **RRS  / Remote Request Substitution / 远程请求替代位**：1 bit 显性位，由于没有用于 CAN XL 的远程帧，因此 RTR 位不是必需的，所以被始终呈显性的 RRS 所取代。（和 CAN FD 一致）

>&#8194;&#8195;When a node transmits a recessive RRS bit and it samples a dominant RRS bit, it shall interpret this as an arbitration lost situation. Receivers shall accept dominant as well as recessive RRS bits.
>
>&#8194;&#8195;This means that the reception of recessive RRS bit is not regarded as form error.

&#8194;&#8195;- **IDE**：1 bit 显性位，但注意 CAN XL 并不支持扩展数据帧。

&#8194;&#8195;- **FDF / FD Format**：1 bit 隐性位，这一位用于区分 CC 和 CAN FD 以及 CAN XL。

>&#8194;&#8195;When a node transmits a recessive FDF bit and it samples a dominant FDF bit, it shall interpret this as an arbitration lost situation.
>
>&#8194;&#8195;**On arbitration lost, the node becomes receiver of a CC frame.**

&#8194;&#8195;- **XLF / XL Format**：1 bit 隐性位，这一位用于区分 CAN FD 和 CAN XL。

>&#8194;&#8195;When a node transmits a recessive XLF bit and it samples a dominant XLF bit, it shall interpret this as an arbitration lost situation.

##### 3.5.8.2.3 &#8194;Control field

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-XLFF_Control_filed.png>

&#8194;&#8195;- **resXL / reserved bit XL format**：1 bit 显性位，为协议未来扩展作保留。

>&#8194;&#8195;Node configuration shall determine how a receiver reacts when it detects the resXL bit to be recessive instead of the expected dominant value. When protocol exception event detection for resXL bit is disabled, CAN XL nodes shall treat this as a form error. When protocol exception event detection for resXL bit is enabled, CAN XL nodes shall detect a protocol-exception event.

&#8194;&#8195;- **ADS / Arbitration-to-Dataphase Switch**：包含 4 bit，按顺序分别是 ADH，DH1，DH2 (前三者均为 1 bit 隐性位) 和 DL1 (1 bit 显性位)，且规定 AHD bit 后应切换为高速（数据）模式。

>&#8194;&#8195;The arbitration to data sequence (ADS) has two purposes: 
>
>&#8194;&#8194;&#8195;1. switching the bit rate from nominal bit rate to the XL data bit rate; 
>
>&#8194;&#8194;&#8195;2. switching the CAN transceiver mode from arbitration mode to data TX mode or to data RX mode.
>
>&#8194;&#8195;**The ADH bit shall be the last bit with nominal bit time before the beginning of the XL data phase with XL data bit rate.**
>
>&#8194;&#8195;**Bit rate switching**:
>
>&#8194;&#8194;&#8194;**The bit rate shall be switched from the nominal bit rate to the XL data bit rate at the boundary between the bits ADH and DH1.**
>
>&#8194;&#8195;Enabling and disabling of the CAN transceiver mode switching shall be configurable. It can be enabled when an appropriate CAN transceiver supporting mode switching is connected.
>
>&#8194;&#8195;Independent of the CAN transceiver mode switching, both transmitter and receiver ignore the actual sampled ADH bit value on the CAN bus (see # [3.5.16.2](#35162-Error-detection)), Exception 3).
>
>&#8194;&#8195;**Note: ADS, together with resXL bit, is designed as a pattern to provide synchronizing edges before and after the transition.**

>&#8194;&#8195;**CAN transceiver mode change**:
>
>&#8194;&#8194;&#8194;When an appropriate CAN transceiver supporting mode switching is connected and the CAN transceiver mode switching is enabled, the time duration of the ADH bit shall be used to signal the CAN transceiver to switch its operating mode from the (default) arbitration mode:
>
>&#8194;&#8195;&#8195;1. into the data TX mode if the node is transmitter,
>
>&#8194;&#8195;&#8195;2. into the data RX mode if the node is receiver.
>
>&#8194;&#8194;&#8195;When the CAN transceiver is not able to switch between operating modes, or when the CAN transceiver mode switching is not used in the network, the signalling shall be disabled by configuration and the CAN transceiver remains in the arbitration mode during the whole frame.

>&#8194;&#8195;**Synchronization**:
>
>&#8194;&#8194;&#8195;A receiver performs a hard synchronization at the edges from the XLF bit to the resXL bit preceding ADS and from the DH1 and DH2 bits to the DL1 bit (see XXX). Between the two synchronizations, a phase error accumulates, caused by clock speed differences between the transmitter and the receiver, by the changed transceiver operating modes, and by the introduction of the PWM coding delay. 
>
>&#8194;&#8194;&#8195;At the bit rate switch, the absolute value of the phase error in relation to the length of the bit time increases by the amount of the bit rate ratio. A tolerance range shall compensate this for the receiver when detecting the DL1 bit.
>
>&#8194;&#8194;&#8195;The receiver shall tolerate from one to six consecutively sampled recessive bits beginning with the position of the DH1 bit. The first bit sampled dominant shall be accepted as DL1. The receiver shall tolerate a missing DH2 bit. The receiver shall detect a form error when it detects seven consecutively sampled recessive bits beginning with the position of the DH1 bit. The receiver shall also detect a form error when it samples DH1 as dominant, what corresponds to an amount of 0 consecutive recessive bits.

&#8194;&#8195;- **SDT / Service Data Unit Type**：8 bit，用来表明传输数据的协议类型，类似于 Ethernet 中的 EtherType。

&#8194;&#8194;&#8195;The 8-bit ISO OSI service data unit (SDU) type (SDT) indicates the used **next OSI layer protocol**.

&#8194;&#8194;&#8195;CiA611-1 specifies 5 SDU Types (SDT) in first version (specification of further values is planed)

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-XLFF_SDT.png>

&#8194;&#8195;- **SEC / Simple Extended Content**: 1 bit, optional DLL security add-on, if further Layer 2 functions added headers to the data field (e.g. Security, Fragmentation).

&#8194;&#8194;&#8195;" The CANsec data link layer security protocol is under development in CiA 613-2. The SEC bit in the control field indicates if the CAN XL DF uses the CANsec protocol. The CANsec protocol features a 4-byte header with cipher control information, the CAN secure channel ID, and a freshness value. The 16-byte trailer contains the authentication tag. The CANsec specifies control and data plane whereas key management is one of the priority topics. The CANsec protocol is an optional add-on functionaltity, which is a part of the measures against cyber-attacks. " ( From Website: CAN in Automation < CIA > )

&#8194;&#8195;- **DLC / Data Length Code**: 11 bit —— The data length code shall be an 11-bit value in the range of 0 to 2047d; The length of the data field shall be in the range from 1 byte to 2048 bytes.

&#8194;&#8195;- **SBC / Stuff Bit Count**: 3-bit value, giving information on the number of dynamic stuff bits in the arbitration field, safeguards against specific error types.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-XLFF_SBC.png>

&#8194;&#8195;- **PCRC / Preface CRC**: 13 bit for CRC_13 algorithm, safeguards the bits up to PCRC.

>&#8194;&#8195;**The relevant bit stream for CRC calculation shall be the bit stream consisting of arbitration field, SDT, SEC bit, DLC and SBC. Dynamic stuff bits (of which up to three can occur before the FDF bit) shall be included in, while the static bits SOF, IDE, FDF, XLF, resXL and ADS as well as the fixed stuff bits shall be excluded from CRC calculation.**

&#8194;&#8195;- **VCID / Virtual CAN Network ID**: allows to separate the CAN Bus into virtual buses ( comparable to VLAN ID in Ethernet ).

&#8194;&#8194;&#8195;"The 8-bit virtual CAN network ID (VCID) field allows running up to 256 logical networks on one single CAN XL physical network segment. This enables the implementation of multiple homogeneous networks determined by the same SDT. That means, CAN XL is able to run several logical (virtual) network applications on the same cable using the same SDT. This field is also an OSI layer management information as described in ISO 7498-4:1998." ( From Website: CAN in Automation < CIA > )

&#8194;&#8195;- **AF / Acceptance Field**: 32 bit, Field for the Addressing, the interpretation of this field depends on SDT.

&#8194;&#8194;&#8195;" **Priority and addressing separated**: In CAN CC and CAN FD, the CAN-ID field ( 11 bit or 29 bit ) is used for both arbitration and addressing purposes. In CAN XL these functions are separated. The CAN XL protocol separates the priority functions ( 11-bit Priority ID ) and the addressing ( 32-bit acceptance field ). 

&#8194;&#8195;&#8195;11-bit Priority: This field provides the uniquely assigned priority of the CAN XL DF.

&#8194;&#8195;&#8195;32-bit acceptance field (AF): This field is included in the 64-bit hardware acceptance filter of the CAN XL controller. It may contain node address or content-indicating information." ( From Website: CAN in Automation < CIA > )

##### 3.5.8.2.4 &#8194;Data filed

>&#8194;&#8195;The data field shall consist of the data passed from the LLC frame, the number of bytes given by frame format and DLC.

##### 3.5.8.2.5 &#8194;CRC filed

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-XLFF_CRC_filed.png>

&#8194;&#8195;- **FCRC / Frame CRC**: 32 bit for CRC_32 algorithm, safeguards the whole frame, i.e. the bits up to the FCRC.

>&#8194;&#8195;The relevant bit stream for the CRC calculation shall be the bit stream consisting of arbitration field, control field, and data field. It shall exclude the same static bits as the PCRC ( the static bits SOF, IDE, FDF, XLF, resXL and ADS ). Both dynamic and fixed stuff bits shall be excluded from the CRC calculation.

&#8194;&#8195;- **FCP / Fromat Check Pattern**: 4 bit，包括 FCP3、FCP2 (2 bit 隐性位) 和 FCP1、FCP0 (2 bit 显性位)，且规定 FCP0 bit 后应切换为低速（仲裁）模式；" Receiver checks if it is aligned to transmitted bit stream. "

>&#8194;&#8195;The FCP sequence is the part of the frame directly before the point where the bit rate is switched back from the data bit rate to the nominal bit rate and where the PMA is signalled to switch back into the arbitration mode.
>
>&#8194;&#8195;It provides a synchronizing edge before the transition, from FCP2 to FCP1. The FCP3 and FCP2 bits are transmitted as recessive bits. The FCP1 and FCP0 bits are transmitted as dominant bits. The FCP0 bit shall be the last bit of the XL data phase.

##### 3.5.8.2.6 &#8194;ACK filed

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_XL-XLFF_ACK_filed.png>

&#8194;&#8195;- **DAS / Dataphase-to-Arbitration Switch**：包含 4 bit，按顺序分别是 DAH，AH1 (均为 1 bit 隐性) 以及 AL1(1 bit 显性) 和 AH2 (1 bit 隐性)，且 DAH bit 为切换至低速（仲裁）模式的第一位。

>&#8194;&#8195;The data to arbitration sequence (DAS) has two purposes:
>
>&#8194;&#8194;&#8195;1. switching the bit rate from the XL data bit rate to the nominal bit rate;
>
>&#8194;&#8194;&#8195;2. switching the CAN transceiver mode from the data TX mode or the data RX mode to the arbitration mode, if the mode is switched in the preceding ADS.
>
>&#8194;&#8195;**The DAH bit shall be the first bit with the nominal bit time after the end of the XL data phase with the XL data bit rate.**
>
>&#8194;&#8195;**Bit rate switching**:
>
>&#8194;&#8194;&#8195;**The bit rate shall be switched from the XL data bit rate to the nominal bit rate at the boundary between the bits FCP0 and DAH.**
>
>&#8194;&#8195;**DAS is designed as a pattern to provide, together with the FCP, synchronizing edges before and after the bit rate switch and (if enabled) the CAN transceiver mode switch.**
>
>&#8194;&#8195;A receiver performs a synchronization at the edge from the FCP2 bit to the FCP1 bit in the CRC field. A receiver performs a hard synchronization from the DAH bit or the AH1 bit to the AL1 bit.
>
>&#8194;&#8195;Between the two synchronizations, a phase error accumulates, caused by clock speed differences between transmitter and receiver, by the changed transceiver operating modes, and by the elimination of the PWM coding delay. 
>
>&#8194;&#8195;The tolerance range specified in the following compensates this for the receiver. A receiver shall interpret the bit following the DAH bit as the AH1 bit if it is sampled recessive and it shall interpret the bit as AL1 bit if it is sampled dominant. A receiver shall tolerate a missing AH1 bit.    
>
>&#8194;&#8195;The transmitter shall detect a bit error, when it samples any bit in the ACK field, except the ACK slot, different from its transmitted value.

>&#8194;&#8195;**CAN transceiver mode change to arbitration mode**:
>
>&#8194;&#8194;&#8195;When the operating mode is switched in the preceding ADS, the time duration of the DAH bit is used to signal the transceiver to switch its operating mode from its actual operating mode back to the (default) arbitration mode.

&#8194;&#8195;- **ACK slot**: Receivers check the consistency of the received XL frame and shall acknowledge a consistent frame by sending a dominant bit in the ACK slot.

&#8194;&#8195;- **ACK delimiter**: The ACK delimiter shall be transmitted as a recessive bit. This means, the ACK slot is surrounded by recessive bits (AH2 and ACK delimiter).

### 3.5.9 &#8194;MAC frame coding

#### 3.5.9.1 &#8194;Coding requirements

>&#8194;&#8195;To limit the maximum distance between edges available for synchronization, the frame segments from SOF to the frame FCRC sequence shall be coded by themethod of the bit stuffing.
>
>&#8194;&#8195;Two methods of the bit stuffing are used in DFs and RFs: dynamic bit stuffing and fixed bit stuffing. The bit stream in a frame shall be coded according to the NRZ method. This means that the generated bit level is constant during the whole bit time.

&#8194;&#8195;NRZ 编码的特征在于，相同极性的连续位没有电平变化；

&#8194;&#8195;NRZ 编码能够实现极高的波特率，同时又可将辐射保持在限制范围内，但 NRZ 编码不是自同步的，即不具有任何同步属性，如果较长时间内没有发生电平变化，则接收方将不能保持同步；

&#8194;&#8195;因此使用 NRZ 编码需要显式同步机制，缺点是会降低传输效率。

&#8194;&#8195;在CAN总线中，使用**位填充**方法作为同步机制：发送方在传输五个相同位后，在位流中插入一个相反的位。

&#8194;&#8195;其次，从设计上考虑，位填充机制同样避免了数据传输与错误帧的处理机制的冲突。

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-NRZ_Coding.png>

&#8194;&#8195;**曼彻斯特编码概述**

&#8194;&#8194;&#8195;- 曼彻斯特编码利用信号的跳变方向来决定数据的，在位中间，信号由高向低跳变表示数据 0，信号由低向高跳变表示数据 1；

&#8194;&#8194;&#8195;- 曼彻斯特编码的频率要比 NRZ 高一倍，传输等量数据所需的带宽大一倍；

&#8194;&#8194;&#8195;- 曼彻斯特编码提供一种同步机制，保证发送端与接收端信号同步；

&#8194;&#8194;&#8195;- 常用于以太网通信中。

#### 3.5.9.2 &#8194;Dynamic bit stuffing

>&#8194;&#8195;Dynamic bit stuffing shall be used in CC frames from the SOF up to and including the FCRC sequence. 
>
>&#8194;&#8195;Dynamic bit stuffing shall be used in FD frames from the SOF up to and including the data field. 
>
>&#8194;&#8195;Dynamic bit stuffing shall be used in XL frames from the SOF up to and including the arbitration field. 
>
>&#8194;&#8195;The last position where such a dynamic stuff bit is possible in XL frames is before the FDF bit. The maximum number of dynamic stuff bits in XL frames is three.
>
>&#8194;&#8195;Whenever a transmitter detects five consecutive bits (including dynamic stuff bits) of the identical value in the bit stream to be transmitted, it shall insert a complementary bit (called dynamic stuff bit) into the actual transmitted bit stream.
>
>&#8194;&#8195;The receiver shall recognize a sequence of five consecutive bits of identical value and shall discard the following dynamic stuff bit.

&#8194;&#8195;由于位填充从以 SOF 的传输为开始，以 CRC 序列的最后一位的传输为结束。因此在传输包含 8 个数据字节的标准格式的数据帧（CC Data Frame）时，在极限情况下，应有24个填充位，理论上标准格式数据帧最多包含 132 位。

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Bit_Stuffing.png>

#### 3.5.9.3 &#8194;Fixed bit stuffing

##### 3.5.9.3.1 &#8194;CAN FD CRC field

>&#8194;&#8195;In the CRC field of FD frames, the stuff bits shall be inserted at fixed positions; they are called fixed stuff bits.
>
>&#8194;&#8195; **There shall be a fixed stuff bit before the first bit of the stuff count**, even if the last bits of the preceding field are not a sequence of five consecutive bits of identical value.
>
>&#8194;&#8195;If the last bits of the preceding field are a sequence of five consecutive bits of identical value, there shall be only the fixed stuff bit, there shall not be two consecutive stuff bits.
>
>&#8194;&#8195;**A further fixed stuff bit shall be inserted after each fourth bit of the CRC field.**
>
>&#8194;&#8195;**The value of such a fixed stuff bit shall be the inverse value of the bit preceding the fixed stuff bit. **
>
>&#8194;&#8195;A receiver shall discard the fixed stuff bits from the bit stream for the CRC check.
>
>&#8194;&#8195;It shall detect a form error if the fixed stuff bit has the same value as its preceding bit.
>
>&#8194;&#8195; The number of fixed stuff bits in the CRC field of FD frames is equal to the maximum number of stuff bits that would result from applying the dynamic bit stuffing method of the CC frames.

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN_FD-Fixed_bit_stuffing.png>

##### 3.5.9.3.2 &#8194;CAN XL data phase

>&#8194;&#8195;**Fixed bit stuffing shall be applied in the control field, data field and FCRC sequence of XL frames**. Here, the stuff bits are inserted at fixed positions; they are called fixed stuff bits.
>
>&#8194;&#8195;**The stuff rate shall be 11, a fixed stuff bit shall be inserted after each 10th frame bit, counted from and including the DL1 bit in the ADS.**
>
>&#8194;&#8195;The value of a fixed stuff bit shall be the inverse value of the bit preceding the fixed stuff bit.
>
>&#8194;&#8195; A receiver shall discard the fixed stuff bits from the bit stream for the CRC check; it shall indicate a form error if the fixed stuff bit has the same value as its preceding bit. 
>
>&#8194;&#8195;The last fixed stuff bit shall be in the FCRC sequence of the CRC field.

### 3.5.10 &#8194;Frame validation

#### 3.5.10.1 &#8194;Behaviour when error signalling is enabled
>&#8194;&#8195;The point in time at which DFs and RFs are taken to be valid is different forreceivers and transmitte

>&#8194;&#8195;**Receiver**
>
>&#8194;&#8195;The frame shall be valid for receivers if there is no error until the last but one bit of EOF. The value of the last bit of EOF shall not inhibit frame validation and a dominant value shall not lead to a form error. A receiver that detects a dominant bit at the last bit of EOF shall respond with an OF.
>
>&#8194;&#8195;**Transmitter**
>
>&#8194;&#8195;The frame shall be valid for a transmitter if there is no error until the end of EOF. If a frame is corrupted, recovery shall be processed as described in # [3.5.14.3.1](#351431-error-handling).

>&#8194;&#8195;If the transmitter samples a dominant bit at the last bit of EOF (a global or a local error at the sender), then the frame is valid for the receiver, but not for the transmitter. The transmitter places an EF and restarts the transmission of the frame and the frame is received twice. The receiver treats the dominant bits as an OF and receives the next frame as an independent second frame. (see # [3.5.14.3.2](#351432-overload-signalling))

#### 3.5.10.2 &#8194;Behaviour when error signalling is disabled
>&#8194;&#8195;The point in time at which a DF is taken to be valid is the same for receivers and transmitters.

>&#8194;&#8195;A frame shall be valid for receivers, if there is no error detected until the ACK slot and the ACK slot is sampled dominant.
>
>&#8194;&#8195;The frame shall be valid for a transmitter, if the ACK slot is sampled dominant. If the transmitter considers the frame as invalid it shall perform a retransmission as specified in # [3.4.6.2](#3462-flow-control-on-retransmission).
>
>&#8194;&#8195;The bits of the frames sampled after the ACK slot shall have no impact on the validation of the frame for a receiver or a transmitter.

### 3.5.11 &#8194;Order of bit transmission

>&#8194;&#8195;Within a field, the MSB is transmitted first. 
>
>&#8194;&#8195;Within the data field, the bytes are transferred from byte 0 to the last byte (indicated by the DLC). 
>
>&#8194;&#8195;Within each byte, the bits are transferred from bit(7) down to bit(0).

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Bit_order.png>

### 3.5.12 &#8194;Medium access method

#### 3.5.12.1 &#8194;Bus access

>&#8194;&#8195;Whenever several nodes start transmitting in coincidence, that node transmitting the frame with the highest priority at this time shall become the bus master.
>
>&#8194;&#8195;An error-active node may access the bus as soon as the bus is idle;
>
>&#8194;&#8195;An error-passive node, which is the **receiver** of the current or previous frame, may access the bus as soon as the bus idle;
>
>&#8194;&#8195;An error-passive node, which is **transmitter** of the current frame or has been **transmitter** of the previous frame, may access the bus assoon as its suspend transmission time is finished, provided that no other node has started transmission meanwhile.

#### 3.5.12.2 &#8194;Transmission of MAC frame

>&#8194;&#8195;MAC frames can be started when the node is allowed to access the bus according to # [3.5.12.1](#35121-Bus-access).
>
>&#8194;&#8195;MAC frames that lose arbitration shall be re-arbitrated. (see # [3.4.6.1](#3461-flow-control-on-re-arbitration))
>
>&#8194;&#8195;MAC frames that are not acknowledged or that are disturbed by errors during the transmission are retransmitted. (see # [3.4.6.2](#3462-flow-control-on-retransmission))

&#8194;&#8195;重新传输（或仲裁）的帧与非重新传输（或仲裁）的帧在处理与总线访问上并无区别。

#### 3.5.12.3 &#8194;Identifier based arbitration

>&#8194;&#8195;During arbitration, every transmitter shall compare the level of the bit transmitted with the level monitored on the bus. 
>
>&#8194;&#8195;If these levels are equal, the transmitter may continue to send. When a CAN node sends a recessive level and monitors a dominant level, the CAN node loses arbitration and shall withdraw from transmitting any more bits, and it shall become receiver of this frame. When a dominant level is sent anda recessive level is monitored, the node shall detect a bit error.

#### 3.5.12.4 &#8194;Frame priority

>&#8194;&#8195;Among two or more frames with different identifiers, the identifier-based arbitration assigns the higher priority to the identifier containing the lower binary value.

&#8194;&#8195;对于 DF，冲裁相同 CAN-ID，从 CBFF - FBFF - XLFF 优先级依次降低；对于 RF，冲裁相同 CAN-ID，CEFF 优先级高于 FEFF。

#### 3.5.12.5 &#8194;Protocol exception event

>&#8194;&#8195;CAN nodes detect a protocol exception event as it is specified in # [3.5.6.1.1.3](#356113-control-field), # [3.5.8.2.3](#35823-control-field), and # [3.5.7.2.3](#356113-control-field). 
>
>&#8194;&#8195;CAN XL nodes shall also detect a protocol exception event when error signalling is disabled as specified in # [3.5.16.4](#35164-Behaviour-when-error-signalling-is-disabled).
>
>&#8194;&#8195;As a reaction to the protocol exception event, the error counters shall not be changed, the hard synchronization shall be enabled, the node shall send recessive bits and shall enter the bus re-integration state (see # [3.5.6.6.5](#35665-Bus-re-integration)).

#### 3.5.12.6 &#8194;Collision resolution

>&#8194;&#8195;Additional to the principle that transmissions are initiated only when the network segment is idle, there are further principles for the collision resolution of frames in XLFF.
>
>&#8194;&#8195;The correct function of the collision resolution requires that within one network segment, each MAC frame uses an arbitration field with a unique value. This enables the resolution of all simultaneously transmitted MAC frames independent of their frame formats.
>
>&#8194;&#8195;The assignment of unique arbitration fields to the PDU is a task of higher OSI layers provided by means of the SDU.

### 3.5.13 &#8194;MAC data consistency

>&#8194;&#8195;MAC frames to be transmitted are prepared by the LLC sub-layer entity user. They are transferred via the node's controller host interface and the LLC sub-layer entity to the MAC entity. MAC frames maybe stored in a shared memory.
>
>&#8194;&#8195;Data consistency of transmitted MAC frames from a shared memory shall be ensured by at least one of two metheods:
>
>&#8194;&#8194;&#8195;- The MAC entity shall store the whole frame content to be transmitted in a temporary buffer that is filled before the transmission is started.
>
>&#8194;&#8194;&#8195;- The LLC entity shall check for data errors while the frame content to be transmitted is transferred to the MAC entity.If a data error is detected, the transmission shall not be started. If it is already started when the data error is detected, the node shall invalidate the frame by, e.g. switching to the restricted operation mode, or into bus monitoring mode. Receiving nodes do not see a valid MAC frame. 
>
>&#8194;&#8195;Data errors are, e.g. parity errors in a RAM word, data not provided in time, or data partially updated by the LLC user while a transmission is in progress.

### 3.5.14 &#8194;Restricted operation

>&#8194;&#8195;CAN nodes shall support the restricted operation mode, in which they shall be able to receive DFs and RFs and shall acknowledge valid frames by means of transmitting adominant bit in the ACK slot. But CAN nodes in restricted operation mode shall not transmit DFs and RFs. 
>
>&#8194;&#8195;In case of an error condition or an overload condition, CAN nodes shall not send dominant bits. Instead they shall treat this as a protocol exception event and shall enter the bus re-integration state (see # [3.5.6.6.5](#35665-Bus-re-integration)). The error counters shall neither be incremented nor decremented while the CAN node is in restricted operation mode. 
>
>&#8194;&#8195;If the CAN node in restricted operation mode is a potential primary time provider in a network, it shall be able to transmit a DF containing time reference messages to start up the network. Other frames shall not be transmitted. 
>
>&#8194;&#8195;Nodes that do not support the XL frame format are not required to implement the restricted operation mode.

### 3.5.15 &#8194;Bus monitoring

>&#8194;&#8195;CAN nodes may provide the bus monitoring mode, where they shall be able to receive valid DFs and valid RFs, but the bus monitoring mode sends only recessive bits on the CAN bus and does not start a transmission. 
>
>&#8194;&#8195;If the MAC sub-layer is required to send a dominant bit (ACK bit, overload flag, active error flag), the bit shall be rerouted internally so that the MAC sub-layer monitors this dominant bit, although the CAN bus can remain in recessive state.

### 3.5.16 &#8194;Error handling and overload handling

#### 3.5.16.1 &#8194;Control of error signalling

>&#8194;&#8195;There shall be a configuration parameter to decide whether error signalling is enabled or is disabled.

#### 3.5.16.2 &#8194;Error detection

>&#8194;&#8195;The MAC sub-layer provides the following mechanisms for the error detection:
>
>&#8194;&#8194;&#8195;- bit monitoring;
>
>&#8194;&#8194;&#8195;- stuff rule check;
>
>&#8194;&#8194;&#8195;- frame format check;
>
>&#8194;&#8194;&#8195;- CRC check;
>
>&#8194;&#8194;&#8195;- ACK check;
>
>&#8194;&#8195;There are five different error types, which are not mutually exclusive. For example, the transmitter sees both, bit error and stuff error, when a correctly transmitted stuff bit is disturbed.

>&#8194;&#8195;**Bit Error**
>
>&#8194;&#8195;A node sending a bit on the bus shall also monitor the bus. A bit error shall be detected at that bit time, when the bit value that is monitored differs from the bit value sent.
>
>&#8194;&#8195;Exception 1: A monitored dominant bit shall not lead to a bit error when a recessive bit, which is not a dynamic stuff bit, is sent during arbitration, or a recessive bit is sent during ACK slot;

>&#8194;&#8195;Exception 2: A node sending a passive error flag and detecting a dominant bit shall not interpret this as a bit error;
>
>&#8194;&#8195;Exception 3: A transmitter shall not detect a bit error at the ADH bit, independent of the actual sampled bit value. (see # [3.5.8.2.3](#35823-control-field))

>&#8194;&#8195;**Stuff Error**
>
>&#8194;&#8195;A stuff error shall be detected at the bit time of the sixth consecutive equal bit level in a field that is coded by the method of dynamic bit stuffing.

>&#8194;&#8195;**CRC Error**
>
>&#8194;&#8195;The CRC sequence consists of the result of theCRC calculation of the transmitter. The receivers shall calculate the CRC in the same way as the transmitter.
>
>&#8194;&#8195;A receiver shall detect an FCRC error when the calculated frame FCRC sequence does not equal the received one;
>
>&#8194;&#8195;A receiver shall check for an FCRC error condition at the sample point of the CRC delimiter.

>&#8194;&#8195;**Form Error**
>
>&#8194;&#8195;A form error shall be detected in the following cases: when a fixed form bit field contains one or more unexpected bit values.
>
>&#8194;&#8195;Exception 1:A receiver detecting a dominant bit at the last bit of EOF, or a node detecting a dominant bit at the last bit of the error delimiter or of the overload delimiter, shall not treat this as a form error;

>&#8194;&#8195;**ACK Error**
>
>&#8194;&#8195;A transmitter shall detect an ACK error whenever it does not detect a dominant bit during the ACK slot.

&#8194;&#8195;对于发送节点，可能出现的错误包括：位错误、格式错误、ACK 错误；

&#8194;&#8195;对于接收节点，可能出现的错误包括：填充错误、格式错误、CRC 错误。

&#8194;&#8195;**Error CASE 1 - 局部错误**

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Case_1.png width="580px">

&#8194;&#8195;**Error CASE 2 - 公共错误**

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Case_2.png width="480px">

&#8194;&#8195;**Error CASE 3 - CRC 错误**

<img src=https://github.com/ONEOKCAT/Vehicle_Notes/blob/main/INSET/CAN-Error_Case_3.png width="580px">

#### 3.5.16.3 &#8194;Behaviour when error signalling is enabled

#### 3.5.16.3.1 &#8194;Error handling

>&#8194;&#8195;When error signalling is enabled, the node shall be able to transmit and to receive all CAN frame formats.
>
>&#8194;&#8195;**Whenever a bit error, a stuff error, a form error, or an ACK error is detected by a node, the LLC sub-layer shall be informed, and the node shall start an error flag at the the following bit.**
>
>&#8194;&#8195;**When a receiver detects an FCRC error, it shall not send a dominant bit in the ACK slot of the received frame.**
>
>&#8194;&#8195;**A receiver receiving a CC frame and detecting an FCRC error shall send an EF starting with the first bit of EOF.**
>
>&#8194;&#8195;**Dominant bits seen between the CRC delimiter and the start of the EF shall not be treated as errors.** （简而言之，出现了 CRC 错误之后，后面的位 <i.e. CRC delimiter、ACK slot、ACK delimiter> 是否再出错已经不重要了。）

>&#8194;&#8195;When error signalling is enabled and a node detects an error during the arbitration phase, the node shall send an EF. 
>
>&#8194;&#8195;When a node detects an error while the data phase bit rate is used, the node shall switch from the data bit time back into the nominal bit time of the arbitration phase before it starts the error flag.

&#8194;&#8195;位错误、填充错误、格式错误以及 ACK 错误产生后：当前发送的下一位发送错误帧；

&#8194;&#8195;CRC 错误：紧随 ACK 界定符，即 EOF 的首位发送错误帧。

#### 3.5.16.3.2 &#8194;Overload signalling

>&#8194;&#8195;The following conditions shall lead to the transmission of an OF:
>
>&#8194;&#8194;&#8195;- a) LLC-requested OF (initiated by the LLC sub-layer): An LLC may cause an OF transmission, when internal conditions of the receiver need a delay of the next MAC DF;
>
>&#8194;&#8194;&#8195;- b) Reactive OF (initiated by the MAC sub-layer): Detection of a dominant bit during either of the first two bits of intermission, detection of one dominant bit at the last bit of EOF by a receiver, or detection of one dominant bit by any node at the last bit of error delimiter or overload delimiter shall cause an OF transmission.
>
>&#8194;&#8195;An LLC-requested OF shall only be started at the first bit of an expected intermission;
>
>&#8194;&#8195;whereas reactive OFs shall start one bit after detecting the dominant bit due to condition b) above;
>
>&#8194;&#8195;The start of LLC-requested OFs due to condition a) above shall be allowed but are not required to be implemented.
>
>&#8194;&#8195;At most, two LLC requested OFs shall be generated to delay the next MAC DF or MAC RF.

&#8194;&#8195;intermission 的第 3 bit 位置为显性将被视为 SOF，出于考虑到 CAN 晶振的影响。 

#### 3.5.16.3.3 &#8194;Restricted operation

>&#8194;&#8195;When both, error signalling and restricted operation mode, are enabled, the restricted operation mode shall take precedence.

#### 3.5.16.3.4 &#8194;Error counting

>&#8194;&#8195;The error counting rules shall apply as specified in xx.

#### 3.5.16.4 &#8194;Behaviour when error signalling is disabled

>&#8194;&#8195;When error signalling is disabled, the node shall transmit and receive only XLFF frames.

&#8194;&#8195;该部分内容会在 CAN-FD 及 CAN-XL 中介绍。 

# 4 &#8194;CAN Physical-Layer Specification

## 4.1 &#8194;General and functional modelling

>&#8194;&#8195;The PL connects CAN nodes with bus.
>
>&#8194;&#8195;The number of nodes is limited by the electric loads on the bus and by the CAN data link layer protocol.
>
>&#8194;&#8195;The PL is modelled according to ISO/IEC/IEEE 8802-3.It has three sub-layers:
>
>&#8194;&#8194;&#8195;- **PSC**: It shall encompass functions related to bit encoding/decoding, timing and synchronization as well as bus failure detection.
>
>&#8194;&#8194;&#8195;- **PMA**: It encompasses functional circuitry for the bus transmission/reception.
>
>&#8194;&#8194;&#8195;- **PMD**: It encompasses the mechanical and electrical interfaces between the physical media and the PMA sub-layer.

## 4.2 &#8194;Services of the PCS interface

>&#8194;&#8195;The services of the PL shall allow the local MAC sub-layer entity to exchange bits with peer MAC sub-layer entities. The PCS shall provide the following services to the MAC sub-layer:
>
>&#8194;&#8194;&#8195;- **PCS_Data.Request**: passed from the MAC sub-layer to the PCS to request the transmission of a bit;

```
   PCS_Data.Request(
            Output_Unit  
            )
```

>&#8194;&#8195;&#8195;The Output_Unit parameter shall take on one of the two values each representing a single bit: dominant or recessive.

>&#8194;&#8194;&#8195;- **PCS_Data.Indicate**: 与上述 Request 对应;

```
   PCS_Data.Indicate(
            Input_Unit
            )
```

>&#8194;&#8194;&#8195;- **PCS_Mode.Request**: passed from the MAC sub-layer to the PCS to indicate that the MAC sub-layer transmits or receives an XL frame;

```
   PCS_Mode.Request(
            XL_Mode
            )
```

>&#8194;&#8195;&#8195;The XL_Mode parameter shall take on one of the two values: active and passive.
>
>&#8194;&#8195;&#8195;When the MAC sub-layer transmits or receives an XL frame and when the CAN transceiver mode switching
is enabled, XL_Mode shall be set to active from the XLF bit of a XL frame until the end of that frame, else it shall be set to passive.

>&#8194;&#8194;&#8195;- **PCS_Status.Transmitter**: passed from the MAC sub-layer to the PCS to indicate that the
MAC sub-layer transmits the FD data phase of an FD frame or that part of an XL frame in which the CAN transceiver is switched into the data TX mode when the CAN transceiver mode switching;

```
   PCS_Status.Transmitter(
              D_Transmit  
              )
```

>&#8194;&#8195;&#8195;The D_Transmit parameter shall take on one of the two values:activeand passive.
>
>&#8194;&#8195;&#8195;In transmitted XL frames, D_Transmit shall be set to active at the beginning of the ADH bit and it shall be set to passive at the beginning of the DAH bit or when that frame is disturbed. In transmitted FD frames, D_Transmitshall be set to active at the beginning of the FD data phase and it shall beset to passive at the end
of the FD data phase or when that frame is disturbed.

>&#8194;&#8194;&#8195;- **PCS_Status.Receiver**: 与上述 Transmitter 对应.

```
   PCS_Status.Receiver(
              D_Receive  
              )
```

## 4.3 &#8194;PCS

### 4.3.1 &#8194;Bit encoding/decoding

### 4.3.2 &#8194;Bit time

>&#8194;&#8195;Bus management functions executed within the PCS, such as the CAN node synchronization behaviour, the compensation of the network transmission delay and the sample point positioning, are realized by the programmable bit timing logic of the CAN node.
>
>&#8194;&#8195;CAN nodes shall support three different bit rates, the nominal bit rate, the FD data bit rate and the XL data
bit rate ———— The XL data bit time shall only be used inside the XL data phase of an XL frame; The FD data bit time shall only be used inside the FD data phase of an FD frame.

### 4.3.3 &#8194;Configuration of the bit time parameters

# 5 &#8194;Description of supervisor FCE
